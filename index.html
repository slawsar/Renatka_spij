<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Śpij Słoneczko | Relaksująca aplikacja do zasypiania</title>
    <!-- Favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Dodatkowe ikony -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Preloadowanie plików audio jako elementy audio dla lepszej kompatybilności -->
    <audio id="preload-ocean" src="sounds/ocean.wav" preload="auto" style="display:none;"></audio>
    <audio id="preload-rain" src="sounds/rain.mp3" preload="auto" style="display:none;"></audio>
    <audio id="preload-forest" src="sounds/forest.mp3" preload="auto" style="display:none;"></audio>
    <audio id="preload-night" src="sounds/night.mp3" preload="auto" style="display:none;"></audio>
    <audio id="preload-whitenoise" src="sounds/whitenoise.wav" preload="auto" style="display:none;"></audio>
    <audio id="preload-dziubasek" src="sounds/dziubasek.mp3" preload="auto" style="display:none;"></audio>
    <audio id="preload-dziubasek-vol2" src="sounds/dziubasek-vol2.mp3" preload="auto" style="display:none;"></audio>
    
    <style>
        /* Główna kolorystyka i ogólne stylowanie */
        :root {
            /* Podstawowe kolory */
            --primary-dark: #0a1128;
            --primary-medium: #1c2541;
            --primary-light: #3a506b;
            --accent: #5bc0be;
            --accent-dark: #3a8a88;
            --text-light: #e9ecef;
            
            /* Przezroczyste warianty kolorów */
            --accent-transparent-light: rgba(91, 192, 190, 0.2);
            --accent-transparent-medium: rgba(91, 192, 190, 0.5);
            --accent-transparent-strong: rgba(91, 192, 190, 0.7);
            --white-transparent-light: rgba(255, 255, 255, 0.05);
            --white-transparent-medium: rgba(255, 255, 255, 0.4);
            --white-transparent-strong: rgba(255, 255, 255, 0.7);
            --black-transparent-light: rgba(0, 0, 0, 0.1);
            --black-transparent-medium: rgba(0, 0, 0, 0.3);
            --black-transparent-strong: rgba(0, 0, 0, 0.5);
            
            /* System cieni */
            --shadow-sm: 0 2px 5px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 15px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.4);
            
            /* System zaokrągleń */
            --radius-sm: 8px;
            --radius-md: 10px;
            --radius-lg: 15px;
            
            /* Czas trwania przejść */
            --transition-speed: 0.3s ease;
        }
        
        body {
            background-color: var(--primary-dark);
            color: var(--text-light);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            transition: background-color var(--transition-speed);
        }
        
        body.light-mode {
            --primary-dark: #e9f5f9;
            --primary-medium: #c4e0f3;
            --primary-light: #93c5fd;
            --accent: #3b82f6;
            --accent-dark: #2563eb;
            --text-light: #0f172a;
            --accent-transparent-light: rgba(59, 130, 246, 0.2);
            --accent-transparent-medium: rgba(59, 130, 246, 0.5);
            --accent-transparent-strong: rgba(59, 130, 246, 0.7);
            background-color: var(--primary-dark);
            color: var(--text-light);
        }
        
        /* Tło z gwiazdami (zastąpione przez Canvas) */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        /* Półprzezroczyste chmury */
        .cloud {
            position: absolute;
            background-color: var(--white-transparent-light);
            border-radius: 50%;
            filter: blur(20px);
            animation: float var(--duration, 60s) infinite linear;
            opacity: 0.3;
        }
        
        @keyframes float {
            0% { transform: translateX(-5%); }
            50% { transform: translateX(5%); }
            100% { transform: translateX(-5%); }
        }
        
        /* Główne elementy stylowania */
        .container {
            padding: 2rem 1rem;
            position: relative;
            z-index: 1;
        }
        
        header {
            text-align: center;
            padding: 2rem 0 1rem;
            position: relative;
        }
        
        h1 {
            color: var(--accent);
            font-size: 2.8rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 10px var(--accent-transparent-strong);
        }
        
        h2 {
            color: var(--accent);
            font-size: 1.8rem;
            margin: 1.5rem 0;
        }
        
        h3 {
            color: var(--accent);
            font-size: 1.5rem;
        }
        
        .card {
            background-color: var(--primary-medium);
            border: none;
            border-radius: var(--radius-lg);
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Stylowanie odtwarzacza dźwięku */
        .sound-player {
            padding: 1.5rem;
        }
        
        .sound-btn {
            background-color: var(--primary-light);
            color: var(--text-light);
            border: none;
            border-radius: var(--radius-md);
            padding: 0.8rem 1.2rem;
            margin: 0.5rem;
            transition: all var(--transition-speed);
            box-shadow: var(--shadow-sm);
        }
        
        .sound-btn:hover {
            background-color: var(--accent);
            color: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .sound-btn.active {
            background-color: var(--accent);
            color: var(--primary-dark);
            box-shadow: 0 0 10px var(--accent);
        }
        
        .sound-card {
            background-color: var(--primary-light);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            opacity: 0.7;
            transition: opacity var(--transition-speed);
        }
        
        .sound-card.active {
            opacity: 1;
            box-shadow: 0 0 10px var(--accent-transparent-medium);
        }
        
        .sound-wave {
            display: flex;
            align-items: flex-end;
            height: 30px;
            width: 50px;
            margin-right: 10px;
        }
        
        .sound-wave.active span {
            animation: soundWave 1s infinite;
        }
        
        .sound-wave span {
            display: inline-block;
            width: 4px;
            margin: 0 2px;
            background-color: var(--accent);
            height: 5px;
            border-radius: 2px;
        }
        
        @keyframes soundWave {
            0%, 100% { height: 5px; }
            50% { height: 20px; }
        }
        
        .sound-wave span:nth-child(1) { animation-delay: 0.1s; }
        .sound-wave span:nth-child(2) { animation-delay: 0.2s; }
        .sound-wave span:nth-child(3) { animation-delay: 0.05s; }
        .sound-wave span:nth-child(4) { animation-delay: 0.3s; }
        .sound-wave span:nth-child(5) { animation-delay: 0.15s; }
        
        .controls {
            margin-top: 2rem;
        }
        
        .slider-container {
            margin: 1.5rem 0;
        }
        
        .form-label {
            color: var(--accent);
            font-weight: 500;
            font-size: 1.1rem;
            margin-bottom: 0.8rem;
        }
        
        .form-range::-webkit-slider-thumb {
            background: var(--accent);
        }
        
        .form-range::-moz-range-thumb {
            background: var(--accent);
        }
        
        /* Stylowanie timera */
        .timer-container {
            text-align: center;
            margin: 1.5rem 0;
        }
        
        .timer-display {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 1rem 0;
            color: var(--accent);
            text-shadow: 0 0 5px var(--accent-transparent-medium);
        }
        
        .custom-timer-container {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .custom-timer-input {
            width: 80px;
            background-color: var(--primary-medium);
            border: 2px solid var(--accent);
            border-radius: var(--radius-sm);
            color: var(--text-light);
            padding: 0.4rem;
            margin-right: 0.5rem;
            text-align: center;
        }
        
        /* Stylowanie dla ćwiczeń relaksacyjnych */
        .relaxation-exercise {
            text-align: center;
            padding: 1.5rem 0;
        }
        
        .breathing-exercise {
            text-align: center;
            padding: 1.5rem 0;
        }
        
        #breathing-description {
            color: var(--text-light);
            font-weight: 500;
            margin-bottom: 1.2rem;
        }
        
        .breathing-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto;
            background-color: var(--accent-transparent-light);
            border: 3px solid var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: transform var(--transition-speed), background-color var(--transition-speed);
        }
        
        .breathing-circle.inhale {
            animation: inhale 4s forwards;
        }
        
        .breathing-circle.hold {
            animation: hold 7s forwards;
        }
        
        .breathing-circle.exhale {
            animation: exhale 8s forwards;
        }
        
        .breathing-circle.box-inhale {
            animation: inhale 4s forwards;
        }
        
        .breathing-circle.box-hold1 {
            animation: hold 4s forwards;
        }
        
        .breathing-circle.box-exhale {
            animation: exhale 4s forwards;
        }
        
        .breathing-circle.box-hold2 {
            animation: hold 4s forwards;
        }
        
        .muscle-relaxation-section {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: var(--radius-md);
            background-color: var(--primary-light);
            text-align: left;
        }
        
        .muscle-group {
            padding: 1.2rem;
            margin-bottom: 1rem;
            border-radius: var(--radius-sm);
            background-color: var(--primary-medium);
            position: relative;
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }
        
        .muscle-group h4 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--accent);
            text-shadow: 0 1px 2px var(--black-transparent-light);
        }
        
        .muscle-group:hover {
            background-color: var(--primary-light);
        }
        
        .muscle-group.active {
            background-color: var(--accent-dark);
        }
        
        .muscle-group.active h4 {
            color: white;
            text-shadow: 0 1px 2px var(--black-transparent-medium);
        }
        
        .muscle-instruction {
            display: none;
            padding: 1.2rem;
            margin-top: 0.7rem;
            border-radius: var(--radius-sm);
            background-color: var(--accent-transparent-light);
            border-left: 4px solid var(--accent);
            font-size: 1.1rem;
            line-height: 1.6;
            color: var(--text-light);
            font-weight: 500;
        }
        
        .muscle-instruction.visible {
            display: block;
        }
        
        .muscle-instruction p {
            margin-bottom: 0.7rem;
            text-shadow: 0 1px 1px var(--black-transparent-light);
        }
        
        .relaxation-progress {
            height: 10px;
            background-color: var(--primary-medium);
            border-radius: 5px;
            margin: 1rem 0;
            overflow: hidden;
        }
        
        .relaxation-progress-bar {
            height: 100%;
            background-color: var(--accent);
            width: 0;
            transition: width var(--transition-speed);
        }
        
        .visualization-scene {
            position: relative;
            height: 200px;
            border-radius: var(--radius-md);
            overflow: hidden;
            margin: 1.5rem 0;
            background-size: cover;
            background-position: center;
        }
        
        .visualization-scene-tabs .exercise-tab.active {
        background-color: var(--accent);
        color: var(--primary-dark);
        box-shadow: 0 0 8px var(--accent);
        transform: translateY(-2px);
        }
        
        .visualization-beach {
            background-image: linear-gradient(to bottom, #87CEEB, #1E90FF);
        }
        
        .visualization-forest {
            background-image: linear-gradient(to bottom, #228B22, #006400);
        }
        
        .visualization-sky {
            background-image: linear-gradient(to bottom, #4169E1, #191970);
        }
        
        .visualization-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-shadow: 1px 1px 3px var(--black-transparent-strong);
            padding: 1rem;
            background-color: var(--black-transparent-light);
        }
        
        .visualization-text {
            font-size: 1.2rem;
            max-width: 80%;
            text-align: center;
            transition: opacity 0.5s ease;
        }
        
        .exercise-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }
        
        .nav-btn {
            background-color: var(--primary-light);
            color: var(--text-light);
            border: none;
            border-radius: var(--radius-sm);
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all var(--transition-speed);
        }
        
        .nav-btn:hover {
            background-color: var(--accent);
            color: var(--primary-dark);
        }
        
        .exercise-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .exercise-tab {
            padding: 0.7rem 1.2rem;
            margin: 0.3rem;
            background-color: var(--primary-light);
            color: var(--text-light);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-speed);
        }
        
        .exercise-tab.active {
            background-color: var(--accent);
            color: var(--primary-dark);
            box-shadow: 0 0 8px var(--accent);
            transform: translateY(-2px);
        }
        
        .exercise-content {
            display: none;
        }
        
        .exercise-content.active {
            display: block;
        }
        
        /* Stylowanie opisów ćwiczeń */
        .exercise-intro {
            font-size: 1.15rem;
            line-height: 1.7;
            color: var(--text-light);
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
            background-color: var(--accent-transparent-light);
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--accent);
            text-shadow: 0 1px 2px var(--black-transparent-light);
        }
        
        @keyframes inhale {
            from { transform: scale(1); background-color: var(--accent-transparent-light); }
            to { transform: scale(1.5); background-color: var(--accent-transparent-medium); }
        }
        
        @keyframes hold {
            from { transform: scale(1.5); background-color: var(--accent-transparent-medium); }
            to { transform: scale(1.5); background-color: var(--accent-transparent-medium); }
        }
        
        @keyframes exhale {
            from { transform: scale(1.5); background-color: var(--accent-transparent-medium); }
            to { transform: scale(1); background-color: var(--accent-transparent-light); }
        }
        
        /* Animacja fali dla wizualizacji plaży */
        .wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 20px;
            background: var(--white-transparent-medium);
            border-radius: 50% 50% 0 0;
            animation: wave 8s infinite linear;
        }
        
        .wave:nth-child(2) {
            height: 15px;
            bottom: 10px;
            opacity: 0.6;
            animation-delay: 0.5s;
        }
        
        .wave:nth-child(3) {
            height: 10px;
            bottom: 15px;
            opacity: 0.4;
            animation-delay: 1s;
        }
        
        @keyframes wave {
            0% { transform: translateX(-50%); }
            100% { transform: translateX(50%); }
        }
        
        /* Sekcja porad dotyczących snu */
        .sleep-tips {
            padding: 1.5rem;
        }
        
        .tip-item {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--primary-light);
        }
        
        .tip-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .tip-item p {
            color: var(--text-light);
            font-size: 1rem;
            line-height: 1.6;
        }
        
        .tip-item h4 {
            color: var(--accent);
            font-size: 1.2rem;
            margin-bottom: 0.8rem;
            font-weight: 600;
        }
        
        .tip-icon {
            color: var(--accent);
            margin-right: 0.5rem;
        }
        
        /* Przełącznik trybu jasny/ciemny */
        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--accent);
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            transition: transform var(--transition-speed);
        }
        
        .theme-toggle:hover {
            transform: rotate(30deg);
        }
        
        /* Stopka */
        footer {
            text-align: center;
            padding: 1.5rem 0;
            margin-top: 1rem;
            color: var(--text-light);
            opacity: 0.7;
        }
        
        /* Animacja księżyca */
        .moon {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background-color: var(--white-transparent-strong);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--white-transparent-strong);
            z-index: 0;
            transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        
        .light-mode .moon {
            background-color: #fbbf24;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.7);
        }
        
        /* Toast powiadomienia */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .custom-toast {
            background-color: var(--primary-medium);
            color: var(--text-light);
            border-left: 4px solid var(--accent);
            box-shadow: var(--shadow-md);
        }
        
        /* Stylowanie dla bajek na dobranoc */
        .bedtime-stories {
            margin-top: 1.5rem;
        }
        
        .story-accordion {
            margin-bottom: 1.5rem;
        }
        
        .story-header {
            padding: 1rem;
            background-color: var(--primary-light);
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            cursor: pointer;
            position: relative;
            transition: background-color var(--transition-speed);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .story-header:hover {
            background-color: var(--accent-transparent-light);
        }
        
        .story-header.active {
            background-color: var(--accent-dark);
        }
        
        .story-header h4 {
            color: var(--text-light);
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .story-header.active h4 {
            color: white;
        }
        
        .story-toggle-icon {
            transition: transform var(--transition-speed);
        }
        
        .story-header.active .story-toggle-icon {
            transform: rotate(180deg);
        }
        
        .story-content {
            display: none;
            padding: 1rem;
            background-color: var(--primary-medium);
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent);
            line-height: 1.6;
        }
        
        .story-content.visible {
            display: block;
        }
        
        .story-content p {
            margin-bottom: 1rem;
            text-shadow: 0 1px 1px var(--black-transparent-light);
            color: var(--text-light); /* Jawne określenie koloru dla zapewnienia widoczności */
            }
        /* Responsywność */
        @media (max-width: 768px) {
            h1 {
                font-size: 2.2rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            .sound-btn {
                padding: 0.6rem 1rem;
                margin: 0.3rem;
                font-size: 0.9rem;
            }
            
            .timer-display {
                font-size: 1.8rem;
            }
            
            .moon {
                width: 40px;
                height: 40px;
                top: 15px;
                left: 15px;
            }
            
            .breathing-circle {
                width: 120px;
                height: 120px;
            }
        }
        
        /* Dodatkowe style dla Canvas */
        #stars-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: -1;
        }
        
        /* Timer wizualizacja */
        .timer-circle {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 1rem auto;
            border-radius: 50%;
            background-color: var(--primary-medium);
            overflow: hidden;
        }
        
        .timer-progress {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--accent) 0deg, transparent 0deg);
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: background 0.5s linear;
        }
        
        .timer-time {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.6rem;
            font-weight: bold;
            color: var(--accent);
            z-index: 2;
        }
        
        @media (max-width: 576px) {
            .timer-circle {
                width: 120px;
                height: 120px;
            }
            
            .timer-time {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Tło z gwiazdami - teraz używamy Canvas zamiast wielu elementów DOM -->
    <div class="stars" id="stars"></div>
    <div class="moon"></div>
    
    <!-- Toast powiadomienia -->
    <div class="toast-container">
        <div class="toast custom-toast" role="alert" aria-live="assertive" aria-atomic="true" id="app-toast">
            <div class="toast-header">
                <strong class="me-auto" id="toast-title">Powiadomienie</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message">
                Wiadomość
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- Przełącznik trybu jasny/ciemny -->
        <button class="theme-toggle" id="theme-toggle" title="Zmień motyw">
            <i class="fas fa-moon" id="theme-icon"></i>
        </button>
        
        <!-- Nagłówek -->
        <header>
            <h1>Śpij Słoneczko</h1>
            <p class="lead">Relaksująca aplikacja stworzona przez dziubaska dla Renatki</p>
        </header>
        
        <!-- Główna zawartość -->
        <main>
            <!-- Odtwarzacz dźwięków i timer -->
            <div class="card sound-player">
                <div class="card-body">
                    <h2><i class="fas fa-music"></i> Relaksujące dźwięki</h2>
                    
                    <!-- Przyciski dźwięków -->
                    <div class="d-flex flex-wrap justify-content-center mb-4">
                        <button class="sound-btn" data-sound="ocean"><i class="fas fa-water"></i> Szum morza</button>
                        <button class="sound-btn" data-sound="rain"><i class="fas fa-cloud-rain"></i> Deszcz</button>
                        <button class="sound-btn" data-sound="forest"><i class="fas fa-tree"></i> Las</button>
                        <button class="sound-btn" data-sound="night"><i class="fas fa-moon"></i> Noc</button>
                        <button class="sound-btn" data-sound="whitenoise"><i class="fas fa-wave-square"></i> Biały szum</button>
                        <button class="sound-btn" data-sound="dziubasek"><i class="fas fa-heart"></i> Dziubasek</button>
                        <button class="sound-btn" data-sound="dziubasek-vol2"><i class="fas fa-heartbeat"></i> Dziubasek Vol.2</button>
                    </div>
                    
                    <!-- Wizualizacja aktywnych dźwięków -->
                    <div class="active-sounds my-3" id="active-sounds-container">
                        <!-- Aktywne dźwięki będą dodawane tutaj dynamicznie -->
                    </div>
                    
                    <div class="controls">
                        <!-- Kontrola głośności -->
                        <div class="slider-container">
                            <label for="volume" class="form-label"><i class="fas fa-volume-up"></i> Głośność</label>
                            <input type="range" class="form-range" id="volume" min="0" max="1" step="0.01" value="0.5">
                        </div>
                        
                        <!-- Timer -->
                        <div class="timer-container">
                            <h3><i class="fas fa-clock"></i> Timer snu</h3>
                            
                            <!-- Dodano wizualny timer -->
                            <div class="timer-circle">
                                <div class="timer-progress" id="timer-progress"></div>
                                <div class="timer-time" id="timer-display">00:00:00</div>
                            </div>
                            
                            <div class="d-flex flex-wrap justify-content-center">
                                <button class="sound-btn timer-btn" data-time="5">5 min</button>
                                <button class="sound-btn timer-btn" data-time="15">15 min</button>
                                <button class="sound-btn timer-btn" data-time="30">30 min</button>
                                <button class="sound-btn timer-btn" data-time="60">1 godz</button>
                                <button class="sound-btn timer-btn" data-time="0"><i class="fas fa-stop"></i> Wyłącz</button>
                            </div>
                            
                            <!-- Niestandardowy timer -->
                            <div class="custom-timer-container mt-3">
                                <input type="number" min="1" max="480" class="custom-timer-input" id="custom-timer-input" placeholder="min">
                                <button class="sound-btn" id="custom-timer-btn"><i class="fas fa-check"></i> Ustaw</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rozbudowane ćwiczenia relaksacyjne -->
            <div class="card relaxation-exercises">
                <div class="card-body">
                    <h2><i class="fas fa-spa"></i> Ćwiczenia relaksacyjne</h2>
                    
                    <div class="exercise-tabs">
                        <button class="exercise-tab active" data-tab="breathing"><i class="fas fa-lungs"></i> Techniki oddechowe</button>
                        <button class="exercise-tab" data-tab="muscle"><i class="fas fa-walking"></i> Relaksacja mięśni</button>
                        <button class="exercise-tab" data-tab="visualization"><i class="fas fa-cloud-sun"></i> Wizualizacje</button>
                        <button class="exercise-tab" data-tab="stories"><i class="fas fa-book"></i> Bajki na dobranoc</button>
                    </div>
                    
                    <!-- Techniki oddechowe -->
                    <div class="exercise-content active" id="breathing-content">
                        <div class="exercise-tabs">
                            <button class="exercise-tab active" data-breathing="478"><i class="fas fa-wind"></i> Technika 4-7-8</button>
                            <button class="exercise-tab" data-breathing="box"><i class="fas fa-square"></i> Oddychanie kwadratowe 4-4-4-4</button>
                            <button class="exercise-tab" data-breathing="diaphragm"><i class="fas fa-circle"></i> Oddychanie przeponowe</button>
                        </div>
                        
                        <div class="breathing-exercise">
                            <p id="breathing-description">Technika 4-7-8 pomaga zrelaksować się i przygotować do snu</p>
                            <div class="breathing-circle" id="breathing-circle">
                                <span id="breathing-text">Kliknij, aby rozpocząć</span>
                            </div>
                            <button class="sound-btn mt-4" id="start-breathing-btn">Rozpocznij ćwiczenie</button>
                        </div>
                    </div>
                    
                    <!-- Progresywna relaksacja mięśni -->
                    <div class="exercise-content" id="muscle-content">
                        <p class="exercise-intro">Progresywna relaksacja mięśni polega na naprzemiennym napinaniu i rozluźnianiu poszczególnych grup mięśni. Wykonuj to ćwiczenie w wygodnej pozycji, najlepiej leżącej.</p>
                        
                        <div class="relaxation-progress">
                            <div class="relaxation-progress-bar" id="muscle-progress"></div>
                        </div>
                        
                        <div class="muscle-relaxation-section">
                            <div class="muscle-group" data-group="hands">
                                <h4><i class="fas fa-hand-paper"></i> Dłonie i przedramiona</h4>
                                <div class="muscle-instruction">
                                    <p>1. Zaciśnij dłonie w pięści tak mocno, jak możesz</p>
                                    <p>2. Utrzymaj napięcie przez 5 sekund</p>
                                    <p>3. Powoli rozluźnij dłonie, czując jak napięcie odpływa</p>
                                    <p>4. Odpoczywaj przez 10 sekund, skupiając się na uczuciu rozluźnienia</p>
                                </div>
                            </div>
                            
                            <div class="muscle-group" data-group="arms">
                                <h4><i class="fas fa-running"></i> Ramiona i bicepsy</h4>
                                <div class="muscle-instruction">
                                    <p>1. Zegnij ręce w łokciach i napnij bicepsy</p>
                                    <p>2. Utrzymaj napięcie przez 5 sekund</p>
                                    <p>3. Powoli rozluźnij mięśnie, pozwalając ramionom opaść swobodnie</p>
                                    <p>4. Odpoczywaj przez 10 sekund, zauważając różnicę między napięciem a rozluźnieniem</p>
                                </div>
                            </div>
                            
                            <div class="muscle-group" data-group="shoulders">
                                <h4><i class="fas fa-user"></i> Barki i kark</h4>
                                <div class="muscle-instruction">
                                    <p>1. Podnieś barki w kierunku uszu (jak przy wzruszaniu ramionami)</p>
                                    <p>2. Utrzymaj napięcie przez 5 sekund</p>
                                    <p>3. Powoli opuść barki, pozwalając im całkowicie opaść</p>
                                    <p>4. Odpoczywaj przez 10 sekund, skupiając się na cieple rozchodzącym się po barkach</p>
                                </div>
                            </div>
                            
                            <div class="muscle-group" data-group="face">
                                <h4><i class="fas fa-smile"></i> Twarz i szczęka</h4>
                                <div class="muscle-instruction">
                                    <p>1. Zaciśnij szczękę, napnij usta i zmruż mocno oczy</p>
                                    <p>2. Utrzymaj napięcie przez 5 sekund</p>
                                    <p>3. Powoli rozluźnij wszystkie mięśnie twarzy</p>
                                    <p>4. Odpoczywaj przez 10 sekund, pozwalając twarzy być całkowicie rozluźnioną</p>
                                </div>
                            </div>
                            
                            <div class="muscle-group" data-group="chest">
                                <h4><i class="fas fa-lungs"></i> Klatka piersiowa i brzuch</h4>
                                <div class="muscle-instruction">
                                    <p>1. Weź głęboki wdech i napnij mięśnie brzucha</p>
                                    <p>2. Utrzymaj napięcie przez 5 sekund</p>
                                    <p>3. Powoli wydychaj powietrze, rozluźniając mięśnie</p>
                                    <p>4. Odpoczywaj przez 10 sekund, oddychając naturalnie</p>
                                </div>
                            </div>
                            
                            <div class="muscle-group" data-group="legs">
                                <h4><i class="fas fa-shoe-prints"></i> Nogi i stopy</h4>
                                <div class="muscle-instruction">
                                    <p>1. Napnij uda, łydki i stopy, podciągając palce stóp do góry</p>
                                    <p>2. Utrzymaj napięcie przez 5 sekund</p>
                                    <p>3. Powoli rozluźnij wszystkie mięśnie nóg</p>
                                    <p>4. Odpoczywaj przez 10 sekund, czując ciężar rozluźnionych nóg</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button class="sound-btn" id="start-muscle-relaxation">Rozpocznij pełne ćwiczenie</button>
                        </div>
                    </div>
                    
                    <!-- Wizualizacje relaksacyjne -->
                    <div class="exercise-content" id="visualization-content">
                        <p class="exercise-intro">Wybierz scenę do wizualizacji. Zamknij oczy, słuchaj opisu i spróbuj wyobrazić sobie to miejsce wszystkimi zmysłami.</p>
                        
                        <div class="exercise-tabs visualization-scene-tabs">
                            <button class="exercise-tab active" data-scene="beach"><i class="fas fa-umbrella-beach"></i> Plaża</button>
                            <button class="exercise-tab" data-scene="forest"><i class="fas fa-tree"></i> Las</button>
                            <button class="exercise-tab" data-scene="sky"><i class="fas fa-cloud-moon"></i> Rozgwieżdżone niebo</button>
                        </div>
                        
                        <div class="visualization-scene visualization-beach" id="visualization-scene">
                            <div class="wave"></div>
                            <div class="wave"></div>
                            <div class="wave"></div>
                            <div class="visualization-overlay">
                                <p class="visualization-text" id="visualization-text">
                                    Wyobraź sobie, że leżysz na ciepłej, miękkiej plaży. Słońce delikatnie ogrzewa twoją skórę.
                                    Słyszysz rytmiczny szum fal, które łagodnie uderzają o brzeg...
                                </p>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <button class="sound-btn" id="start-visualization">Rozpocznij wizualizację</button>
                        </div>
                    </div>
                    
                    <!-- Bajki na dobranoc -->
                    <div class="exercise-content" id="stories-content">
                        <p class="exercise-intro">Wybierz jedną z bajek na dobranoc. Przeczytaj lub opowiedz ją, aby pomóc w wyciszeniu się przed snem.</p>
                        
                        <div class="bedtime-stories">
                            <div class="story-accordion">
                                <div class="story-header" data-story="star">
                                    <h4><i class="fas fa-star tip-icon"></i> Renatka, Gwiazda o Złotym Blasku</h4>
                                    <i class="fas fa-chevron-down story-toggle-icon"></i>
                                </div>
                                <div class="story-content" id="star-story">
                                    <p>Dawno temu, wysoko na niebie mieszkała mała gwiazda o imieniu Renatka. Renatka była wyjątkowa – w przeciwieństwie do innych gwiazd, które kochały noc, ona czasem bała się ciemności.</p>
                                    <p>"Jak możesz bać się ciemności?" - pytały inne gwiazdy. "Przecież jesteśmy gwiazdami! Świecimy właśnie w ciemności!"</p>
                                    <p>Ale Renatka nie zawsze potrafiła poradzić sobie ze swoim lękiem. Czasami jej blask był mniej intensywny, jakby przytłumiony przez niepewność.</p>
                                    <p>Pewnej nocy Renatka spotkała inną gwiazdę o imieniu Dziubasek, który zauważył jej zmartwienie. "Droga Renatko," powiedział łagodnie, "pozwól, że zdradzę ci pewien sekret. Ciemność nie jest niczym strasznym. To po prostu przestrzeń czekająca, aż wypełni ją nasze światło."</p>
                                    <p>Renatka zastanowiła się nad tymi słowami. "Ale co jeśli moje światło jest zbyt małe, aby wypełnić całą tę ciemność?" - zapytała.</p>
                                    <p>"Spójrz w dół, na Ziemię," odpowiedział Dziubasek. Renatka spojrzała i zobaczyła małą dziewczynkę, która nie mogła zasnąć, gdyż również bała się ciemności. Dziewczynka wyglądała przez okno, szukając światła na niebie.</p>
                                    <p>"Widzisz?" - powiedział Dziubasek. "Dla tej małej dziewczynki twoje światło może być najjaśniejszym punktem w nocy, przewodnikiem i pocieszeniem."</p>
                                    <p>Renatka pomyślała o dziewczynce – o kimś, kto potrzebował jej światła tak samo, jak ona potrzebowała odwagi. Nagle poczuła, jak jej strach zaczyna znikać, a jej światło staje się coraz jaśniejsze.</p>
                                    <p>Od tej nocy Renatka i Dziubasek świecili razem, jako dwie najjaśniejsze gwiazdy na niebie. A mała dziewczynka patrząc na nich, czuła się bezpieczna i mogła spokojnie zasnąć.</p>
                                    <p>I tak Renatka odkryła, że kiedy jest się z kimś, kto daje wsparcie i miłość, wszystkie lęki stają się mniejsze, a nasze wewnętrzne światło świeci najjaśniej.</p>
                                </div>
                            </div>
                            
                            <div class="story-accordion">
                                <div class="story-header" data-story="forest">
                                    <h4><i class="fas fa-tree tip-icon"></i> Dziubasek i Las Pięknych Snów</h4>
                                    <i class="fas fa-chevron-down story-toggle-icon"></i>
                                </div>
                                <div class="story-content" id="forest-story">
                                    <p>W samym sercu Czarodziejskiego Lasu mieszkał mądry ptaszek o imieniu Dziubasek. Znany był ze swojej niezwykłej zdolności – umiał tworzyć piękne sny i dzielić się nimi z tymi, którzy mieli trudności ze spaniem.</p>
                                    <p>Co wieczór zwierzęta i leśne duszki przychodziły do jego przytulnego gniazdka, słuchając jego kojących opowieści, które pomagały im zasnąć. Dziubasek znał wiele historii – sny o lataniu dla wiewiórek, sny o pływaniu dla żabek, kolorowe sny dla motyli i przytulne sny dla jeżyków.</p>
                                    <p>Pewnego wieczoru do lasu przywędrowała zmęczona dziewczynka o imieniu Renatka. Miała za sobą długi dzień pełen przygód i potrzebowała dobrego odpoczynku, ale miała problem – jej umysł był pełen myśli i nie potrafiła zasnąć.</p>
                                    <p>"Próbowałam wszystkiego," wyszeptała do Dziubaska, "liczyłam owce, piłam ciepłe mleko z miodem, nawet słuchałam kołysanek, ale nic nie działa. Czy możesz mi pomóc?"</p>
                                    <p>Dziubasek spojrzał na Renatkę z czułością. "Twój problem, kochana Renatko, polega na tym, że twój umysł nadal pracuje, kiedy twoje ciało chce odpocząć. Potrzebujesz wyjątkowego snu, który pomoże ci się wyciszyć."</p>
                                    <p>Dziubasek zastanowił się przez chwilę, a potem zaczął nucić delikatną melodię. "To jest Melodia Spokoju. Jest wyjątkowa i stworzona specjalnie dla ciebie."</p>
                                    <p>Renatka słuchała z zamkniętymi oczami. Delikatny głos Dziubaska ukołysał ją do snu, a w jej śnie znalazła się na spokojnej polanie, gdzie słyszała tylko delikatny szept wiatru i śpiew ptaków. Powoli, jej oddech stał się głębszy, a myśli spokojniejsze.</p>
                                    <p>Rano Renatka obudziła się wypoczęta jak nigdy wcześniej. Czuła się lekka i pełna energii. Od tego dnia, zanim poszła spać, zawsze przypominała sobie melodię Dziubaska i wyobrażała sobie spokojną polanę ze swojego snu.</p>
                                    <p>"Melodia jest zawsze w twoim sercu," powiedział Dziubasek, gdy Renatka przyszła mu podziękować. "Nauczyłaś się, jak odnaleźć spokój w sobie. To jest prawdziwa magia dobrego snu."</p>
                                    <p>I tak Renatka odkryła, że najpiękniejsze sny rodzą się z miłości i troski, a najlepszym przewodnikiem do krainy spokojnego snu jest ktoś, kto troszczy się o nas całym sercem.</p>
                                </div>
                            </div>
                            
                            <div class="story-accordion">
                                <div class="story-header" data-story="moon">
                                    <h4><i class="fas fa-moon tip-icon"></i> Renatka, Księżyc i Nocne Marzenia</h4>
                                    <i class="fas fa-chevron-down story-toggle-icon"></i>
                                </div>
                                <div class="story-content" id="moon-story">
                                    <p>Każdej nocy, gdy cały świat zasypiał, Renatka stawała się Księżycem Marzeń. Nie było to tylko zwykłe świecenie na niebie – jej najważniejszym zadaniem było zbieranie i spełnianie marzeń śpiących ludzi.</p>
                                    <p>Używając swoich srebrzystych promieni jak delikatnych rąk, ostrożnie podnosiła marzenia, które unosiły się nad głowami śpiących. Niektóre marzenia były lekkie jak piórka, inne ciężkie jak kamienie. Niektóre błyszczały kolorami tęczy, inne były ciche i skromne. Renatka kochała je wszystkie.</p>
                                    <p>Po zebraniu marzeń, Renatka-Księżyc zabierała je wysoko na niebo, gdzie jej przyjaciel Dziubasek, najjaśniejsza gwiazda, pomagał jej opiekować się marzeniami. Każdej nocy razem karmili je światłem i magią, sprawiając, że stawały się silniejsze.</p>
                                    <p>Pewnej nocy Renatka zauważyła wyjątkowe marzenie – należało do małego chłopca, który pragnął stworzyć coś pięknego dla kogoś, kogo kochał. Jego marzenie było wyjątkowo jasne i przyciągało uwagę. "To marzenie potrzebuje specjalnej opieki," pomyślała, powierzając je Dziubaskowi.</p>
                                    <p>"To przypomina mi nasze pierwsze spotkanie," powiedział Dziubasek z uśmiechem. "Pamiętasz? Też marzyłem, by stworzyć dla ciebie coś pięknego."</p>
                                    <p>Mijały noce i miesiące. Marzenie chłopca rosło i nabierało kształtów, aż pewnej nocy, gdy spał, stało się coś magicznego. W swoim śnie zobaczył dokładnie, co ma zrobić, by wyrazić swoją miłość – dokładnie tak, jak kiedyś Dziubasek zrozumiał, jak pokazać swoje uczucia Renatce.</p>
                                    <p>Gdy chłopiec się obudził, poczuł radość i spełnienie, choć nie pamiętał dokładnie swojego snu. Wiedział tylko, że jest szczęśliwy i że znalazł rozwiązanie, którego szukał.</p>
                                    <p>Tej samej nocy, gdy chłopiec spał, Renatka i Dziubasek zobaczyli coś niezwykłego – z jego serca unosiło się nowe marzenie, tym razem o pomaganiu innym w spełnianiu ich własnych marzeń.</p>
                                    <p>Renatka-Księżyc uśmiechnęła się do Dziubaska-Gwiazdy. Najpiękniejsza część ich pracy to nie tylko zbieranie marzeń, ale obserwowanie, jak jedno spełnione marzenie rodzi kolejne, jeszcze piękniejsze.</p>
                                    <p>I tak, każdej nocy, gdy patrzysz na niebo i widzisz Księżyc otoczony gwiazdami, pamiętaj – to Renatka i Dziubasek opiekują się twoimi najcenniejszymi marzeniami, aż nadejdzie czas, by stały się rzeczywistością.</p>
                                </div>
                            </div>
                            
                            <div class="story-accordion">
                                <div class="story-header" data-story="cloud">
                                    <h4><i class="fas fa-cloud tip-icon"></i> Dziubasek, Chmurka Pełna Miłości</h4>
                                    <i class="fas fa-chevron-down story-toggle-icon"></i>
                                </div>
                                <div class="story-content" id="cloud-story">
                                    <p>Wysoko na niebie, gdzie powietrze jest czyste i błękitne, żyła sobie mała chmurka o imieniu Dziubasek. Był najmniejszy spośród wszystkich obłoków na niebie i czasem czuł się niepewnie.</p>
                                    <p>"Jesteś zbyt mały, by tworzyć deszcz," mówiły większe chmury. "Nawet twój cień jest ledwo widoczny na ziemi."</p>
                                    <p>Dziubasek marzył o tym, by pewnego dnia stać się potężnym obłokiem, który mógłby przynosić życiodajny deszcz spragnionym polom i lasom. Ale bez względu na to, jak bardzo się starał, pozostawał maleńki i puszysty.</p>
                                    <p>Pewnego dnia silny wiatr porwał Dziubaska i poniósł daleko od innych chmur, nad piękny ale wysuszony ogród. Dziubasek zauważył tam samotny kwiat o imieniu Renatka, który walczył o przetrwanie w letnim upale.</p>
                                    <p>Gdy tak dryfował nad ogrodem, usłyszał cichy głos. "Proszę, chmurko, zostań ze mną choć na chwilę." To była Renatka, delikatny słonecznik spragniony odrobiny wilgoci.</p>
                                    <p>"Jestem tylko małym Dziubaskiem," odpowiedziała chmurka. "Nie mam w sobie deszczu, nie potrafię dać ci wody, której potrzebujesz."</p>
                                    <p>"Ale twój cień," powiedziała Renatka, "daje mi chwilę wytchnienia od palącego słońca. To więcej, niż miałam od wielu dni."</p>
                                    <p>Dziubasek nigdy nie pomyślał, że jego mały cień mógłby być dla kogoś tak ważny. Postanowił zostać nad Renatką tak długo, jak się da. Przez cały dzień zapewniał jej cień i ochłodę.</p>
                                    <p>Gdy wieczorem słońce zachodziło, Dziubasek poczuł coś niezwykłego - zaczął czuć się cięższy. To jego miłość i troska o Renatkę sprawiły, że w jego wnętrzu zaczęły formować się maleńkie kropelki wody.</p>
                                    <p>"Dziubasku, co się dzieje?" - zapytała zdziwiona Renatka, gdy pojedyncze krople zaczęły spadać na jej płatki.</p>
                                    <p>"To niemożliwe," wyszeptał zdumiony Dziubasek. "Jestem zbyt mały, by tworzyć deszcz..."</p>
                                    <p>Ale czasami to właśnie miłość i troska potrafią czynić niemożliwe możliwym. Dziubasek nie stał się wielką, burzową chmurą - zamiast tego stał się dokładnie taką chmurką, jakiej Renatka potrzebowała.</p>
                                    <p>Z czasem Dziubasek nauczył się, że prawdziwa wielkość nie zawsze zależy od rozmiaru. Czasami najmniejsza kropla deszczu może mieć największe znaczenie dla kogoś, kto jej potrzebuje.</p>
                                    <p>Od tamtego dnia Dziubasek i Renatka byli nierozłączni. Codziennie rano Dziubasek przynosił swojej ukochanej słoneczniczce dokładnie tyle wody, ile potrzebowała, a ona w podzięce zawsze odwracała swój złoty kielich w jego stronę, nawet gdy było pochmurno.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Porady dotyczące snu -->
            <div class="card sleep-tips">
                <div class="card-body">
                    <h2><i class="fas fa-bed"></i> Porady dla lepszego snu</h2>
                    <div class="tip-item">
                        <h4><i class="fas fa-calendar-alt tip-icon"></i> Regularne godziny snu</h4>
                        <p>Staraj się chodzić spać i budzić się o tej samej porze każdego dnia, nawet w weekendy. To pomaga w regulacji twojego wewnętrznego zegara biologicznego.</p>
                    </div>
                    <div class="tip-item">
                        <h4><i class="fas fa-mobile-alt tip-icon"></i> Unikaj niebieskiego światła</h4>
                        <p>Ogranicz korzystanie z urządzeń elektronicznych (telefon, tablet, laptop) co najmniej godzinę przed snem. Niebieskie światło emitowane przez te urządzenia może zakłócać produkcję melatoniny.</p>
                    </div>
                    <div class="tip-item">
                        <h4><i class="fas fa-spa tip-icon"></i> Stwórz rytuał przed snem</h4>
                        <p>Rozwijaj rytuały, które sygnalizują twojemu ciału, że czas się zrelaksować. Może to być czytanie książki, ciepła kąpiel, medytacja lub słuchanie kojącej muzyki.</p>
                    </div>
                    <div class="tip-item">
                        <h4><i class="fas fa-mug-hot tip-icon"></i> Pij ziołowe herbaty przed snem</h4>
                        <p>Ciepłe ziołowe napary, takie jak melisa, rumianek, lawenda czy lipa, pomagają się zrelaksować i przygotować ciało do snu. Wypijaj filiżankę około godzinę przed planowanym czasem snu.</p>
                    </div>
                    <div class="tip-item">
                        <h4><i class="fas fa-temperature-low tip-icon"></i> Komfortowa sypialnia</h4>
                        <p>Upewnij się, że twoja sypialnia jest ciemna, cicha i ma odpowiednią temperaturę (18-20°C). Wygodny materac i poduszki również są ważne dla jakości snu.</p>
                    </div>
                    <div class="tip-item">
                        <h4><i class="fas fa-headphones tip-icon"></i> Personalizuj dźwięki do zasypiania</h4>
                        <p>Wybieraj dźwięki, które osobiście działają na Ciebie uspokajająco. Możesz nagrać swoje ulubione odgłosy natury podczas spaceru, szum morza z wakacji, czy nawet znajome dźwięki domowe, które kojarzą Ci się z bezpieczeństwem i spokojem.</p>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Stopka -->
        <footer>
            <p>© 2025 Śpij Słoneczko | Stworzone z miłością przez dziubaska dla Renatki 💝🌞💝</p>
            <p><a href="#" id="save-preferences" class="text-decoration-none" style="color: var(--accent)">Zapisz preferencje</a></p>
        </footer>
    </div>
    
    <!-- Szablony HTML -->
    <template id="sound-card-template">
        <div class="sound-card mb-2">
            <div class="d-flex align-items-center">
                <div class="sound-wave me-2">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <span class="sound-name"></span>
            </div>
            <div>
                <input type="range" class="form-range individual-volume" min="0" max="1" step="0.01" value="0.5" style="width: 100px;">
                <button class="btn-close sound-close ms-2" aria-label="Close"></button>
            </div>
        </div>
    </template>
    
    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <!-- Główny skrypt JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicjalizacja tooltipów Bootstrap
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Inicjalizacja toastów
            const toastEl = document.getElementById('app-toast');
            const toast = new bootstrap.Toast(toastEl, {
                autohide: true,
                delay: 3000
            });
            
            // Funkcja do pokazywania powiadomień
            function showToast(title, message) {
                document.getElementById('toast-title').textContent = title;
                document.getElementById('toast-message').textContent = message;
                toast.show();
            }
            
            // Tworzenie gwiazdnego tła za pomocą Canvas
            function createStarryBackground() {
                const starsContainer = document.getElementById('stars');
                const canvas = document.createElement('canvas');
                canvas.id = 'stars-canvas';
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                starsContainer.appendChild(canvas);
                
                const ctx = canvas.getContext('2d');
                const starsCount = 150;
                const stars = [];
                
                // Tworzenie gwiazd z ich właściwościami
                for (let i = 0; i < starsCount; i++) {
                    stars.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        size: Math.random() * 2 + 1,
                        intensity: 0.2 + Math.random() * 0.8,
                        phase: Math.random() * Math.PI * 2
                    });
                }
                
                // Dodanie kilku chmur
                const clouds = [];
                for (let i = 0; i < 5; i++) {
                    clouds.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * (canvas.height / 2),
                        width: 100 + Math.random() * 200,
                        height: 50 + Math.random() * 100,
                        speed: 0.1 + Math.random() * 0.2,
                        opacity: 0.1 + Math.random() * 0.2
                    });
                }
                
                // Funkcja animacji
                function animate() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    const time = Date.now() / 1000;
                    
                    // Rysuj gwiazdy
                    stars.forEach(star => {
                        const intensity = star.intensity * (0.5 + 0.5 * Math.sin(time + star.phase));
                        ctx.fillStyle = `rgba(255, 255, 255, ${intensity})`;
                        ctx.beginPath();
                        ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    
                    // Rysuj chmury
                    clouds.forEach(cloud => {
                        cloud.x += cloud.speed;
                        if (cloud.x > canvas.width + cloud.width) {
                            cloud.x = -cloud.width;
                        }
                        
                        ctx.fillStyle = `rgba(255, 255, 255, ${cloud.opacity})`;
                        ctx.beginPath();
                        ctx.ellipse(cloud.x, cloud.y, cloud.width / 2, cloud.height / 2, 0, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    
                    requestAnimationFrame(animate);
                }
                
                animate();
                
                // Obsługa zmiany rozmiaru okna
                window.addEventListener('resize', function() {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                });
            }
            
            // Inicjalizacja tła gwieździstego
            createStarryBackground();
            
            // ========== PRZEŁĄCZNIK TRYBU JASNY/CIEMNY ==========
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            
            // Sprawdź, czy użytkownik ma zapisane preferencje
            const savedTheme = localStorage.getItem('spijSloneczko-theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            }
            
            themeToggle.addEventListener('click', function() {
                document.body.classList.toggle('light-mode');
                
                if (document.body.classList.contains('light-mode')) {
                    themeIcon.classList.remove('fa-moon');
                    themeIcon.classList.add('fa-sun');
                    localStorage.setItem('spijSloneczko-theme', 'light');
                } else {
                    themeIcon.classList.remove('fa-sun');
                    themeIcon.classList.add('fa-moon');
                    localStorage.setItem('spijSloneczko-theme', 'dark');
                }
            });
            
            // ========== SYSTEM ODTWARZANIA DŹWIĘKÓW ==========
            
            // Pobranie elementów DOM
            const soundButtons = document.querySelectorAll('.sound-btn[data-sound]');
            const volumeSlider = document.getElementById('volume');
            const timerButtons = document.querySelectorAll('.timer-btn');
            const timerDisplay = document.getElementById('timer-display');
            const timerProgress = document.getElementById('timer-progress');
            const customTimerInput = document.getElementById('custom-timer-input');
            const customTimerBtn = document.getElementById('custom-timer-btn');
            const activeContainer = document.getElementById('active-sounds-container');
            const soundCardTemplate = document.getElementById('sound-card-template');
            
            // Timer
            let timerInterval = null;
            let timerEndTime = null;
            let timerStartTime = null;
            
            // Przechowywanie aktywnych dźwięków (jako mapa)
            const activeSounds = new Map();
            
            // Pula Audio - optymalizacja tworzenia obiektów Audio
            const audioPool = {
                pool: new Map(),
                
                getAudio: function(source) {
                    if (!this.pool.has(source)) {
                        const audio = new Audio(source);
                        audio.load(); // Preload audio
                        this.pool.set(source, audio);
                    }
                    return this.pool.get(source).cloneNode(); // Zawsze zwracaj kopię
                }
            };
            
            // ===== KONFIGURACJA DŹWIĘKÓW =====
            const sounds = {
                'ocean': 'sounds/ocean.wav',
                'rain': 'sounds/rain.mp3',
                'forest': 'sounds/forest.mp3',
                'night': 'sounds/night.mp3',
                'whitenoise': 'sounds/whitenoise.wav',
                'dziubasek': 'sounds/dziubasek.mp3',
                'dziubasek-vol2': 'sounds/dziubasek-vol2.mp3'
            };
            
            // Mapowanie nazw dźwięków na przyjazne nazwy polskie
            const soundNames = {
                'ocean': 'Szum morza',
                'rain': 'Deszcz',
                'forest': 'Las',
                'night': 'Noc',
                'whitenoise': 'Biały szum',
                'dziubasek': 'Dziubasek',
                'dziubasek-vol2': 'Dziubasek Vol.2'
            };
            
            // Mapowanie nazw dźwięków na ikony
            const soundIcons = {
                'ocean': 'fa-water',
                'rain': 'fa-cloud-rain',
                'forest': 'fa-tree',
                'night': 'fa-moon',
                'whitenoise': 'fa-wave-square',
                'dziubasek': 'fa-heart',
                'dziubasek-vol2': 'fa-heartbeat'
            };
            
            // Funkcja tworząca element karty dźwięku
            function createSoundCard(soundName, audio) {
                const template = soundCardTemplate.content.cloneNode(true);
                const card = template.querySelector('.sound-card');
                card.dataset.sound = soundName;
                
                // Ustaw nazwę dźwięku
                const nameElement = card.querySelector('.sound-name');
                nameElement.textContent = soundNames[soundName] || soundName;
                
                // Dodaj ikonę
                const iconClass = soundIcons[soundName];
                if (iconClass) {
                    const icon = document.createElement('i');
                    icon.className = `fas ${iconClass} me-2`;
                    nameElement.prepend(icon);
                }
                
                // Ustaw klasę aktywną dla wizualizacji dźwięku
                card.classList.add('active');
                const soundWave = card.querySelector('.sound-wave');
                soundWave.classList.add('active');
                
                // Obsługa indywidualnej głośności
                const volumeControl = card.querySelector('.individual-volume');
                volumeControl.value = audio.volume;
                volumeControl.addEventListener('input', function() {
                    audio.volume = parseFloat(this.value);
                });
                
                // Obsługa przycisku zamykania
                const closeBtn = card.querySelector('.sound-close');
                closeBtn.addEventListener('click', function() {
                    stopSound(soundName);
                });
                
                return card;
            }
            
            // Funkcja odtwarzania dźwięku
            function playSound(soundName) {
                // Jeśli dźwięk jest już odtwarzany, zatrzymaj go
                if (activeSounds.has(soundName)) {
                    stopSound(soundName);
                    return;
                }
                
                try {
                    // Sprawdź, czy ścieżka do dźwięku istnieje
                    if (!sounds[soundName]) {
                        showToast("Błąd", `Brak pliku dźwiękowego dla: ${soundName}`);
                        return;
                    }
                    
                    // Pobierz dźwięk z puli
                    const audio = audioPool.getAudio(sounds[soundName]);
                    
                    // Ustawienia
                    audio.loop = true; // Zapętlenie dźwięku
                    
                    // Pobierz aktualną wartość głośności z suwaka
                    const volume = parseFloat(volumeSlider.value);
                    audio.volume = volume;
                    
                    // Rozszerzona obsługa błędów
                    audio.onerror = function(e) {
                        console.error(`Błąd ładowania dźwięku ${soundName}:`, e);
                        showToast("Błąd", `Nie można załadować dźwięku: ${soundNames[soundName]}`);
                        stopSound(soundName);
                    };
                    
                    // Rozpocznij odtwarzanie
                    audio.play().catch(err => {
                        console.error("Błąd odtwarzania:", err);
                        showToast("Błąd", "Błąd odtwarzania dźwięku. Sprawdź uprawnienia przeglądarki.");
                    });
                    
                    // Dodaj dźwięk do aktywnych
                    activeSounds.set(soundName, audio);
                    
                    // Dodaj klasę active do przycisku
                    document.querySelector(`.sound-btn[data-sound="${soundName}"]`).classList.add('active');
                    
                    // Dodaj kartę dźwięku do kontenera
                    const soundCard = createSoundCard(soundName, audio);
                    activeContainer.appendChild(soundCard);
                    
                } catch (error) {
                    console.error("Nieoczekiwany błąd:", error);
                    showToast("Błąd", "Wystąpił nieoczekiwany błąd podczas odtwarzania dźwięku");
                }
            }
            
            // Zatrzymanie pojedynczego dźwięku
            function stopSound(soundName) {
                if (activeSounds.has(soundName)) {
                    const audio = activeSounds.get(soundName);
                    audio.pause();
                    audio.currentTime = 0;
                    
                    // Wyczyść nasłuchiwacze zdarzeń - zapobieganie wyciekom pamięci
                    audio.onended = null;
                    audio.onerror = null;
                    audio.oncanplay = null;
                    
                    activeSounds.delete(soundName);
                    
                    // Usuń klasę active z przycisku
                    const button = document.querySelector(`.sound-btn[data-sound="${soundName}"]`);
                    if (button) button.classList.remove('active');
                    
                    // Usuń kartę dźwięku
                    const card = document.querySelector(`.sound-card[data-sound="${soundName}"]`);
                    if (card) card.remove();
                }
            }
            
            // Zatrzymanie wszystkich dźwięków
            function stopAllSounds() {
                for (const [soundName, audio] of activeSounds.entries()) {
                    audio.pause();
                    audio.currentTime = 0;
                    
                    // Wyczyść nasłuchiwacze zdarzeń
                    audio.onended = null;
                    audio.onerror = null;
                    audio.oncanplay = null;
                    
                    // Usuń klasę active z przycisku
                    const button = document.querySelector(`.sound-btn[data-sound="${soundName}"]`);
                    if (button) button.classList.remove('active');
                }
                
                activeSounds.clear();
                activeContainer.innerHTML = '';
            }
            
            // Funkcja do płynnego wyciszania dźwięków
            function fadeOutAllSounds(duration = 3000) {
                // Zapisz początkowe głośności dla każdego dźwięku
                const initialVolumes = new Map();
                for (const [soundName, audio] of activeSounds.entries()) {
                    initialVolumes.set(soundName, audio.volume);
                }
                
                const startTime = Date.now();
                const fadeInterval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const ratio = 1 - Math.min(elapsed / duration, 1);
                    
                    // Aktualizuj głośność każdego dźwięku
                    for (const [soundName, audio] of activeSounds.entries()) {
                        audio.volume = initialVolumes.get(soundName) * ratio;
                    }
                    
                    // Zatrzymaj interwał i dźwięki po zakończeniu wyciszania
                    if (elapsed >= duration) {
                        clearInterval(fadeInterval);
                        stopAllSounds();
                    }
                }, 50);
            }
            
            // Ustawienie timera
            function setTimer(minutes) {
                // Wyczyszczenie istniejącego timera
                clearInterval(timerInterval);
                
                // Usunięcie klasy active ze wszystkich przycisków timera
                timerButtons.forEach(btn => btn.classList.remove('active'));
                
                // Jeśli minutes wynosi 0, wyczyść timer
                if (minutes === 0) {
                    timerDisplay.textContent = '00:00:00';
                    timerProgress.style.background = 'conic-gradient(var(--accent) 0deg, transparent 0deg)';
                    timerEndTime = null;
                    timerStartTime = null;
                    return;
                }
                
                // Aktywuj przycisk timera jeśli jest standardowym timerem
                const timerBtn = document.querySelector(`.timer-btn[data-time="${minutes}"]`);
                if (timerBtn) {
                    timerBtn.classList.add('active');
                }
                
                // Oblicz czas zakończenia
                timerStartTime = new Date();
                timerEndTime = new Date(timerStartTime.getTime() + minutes * 60000);
                
                // Natychmiast aktualizuj wyświetlanie timera
                updateTimerDisplay();
                
                // Ustaw interwał do aktualizacji wyświetlania
                timerInterval = setInterval(function() {
                    if (!updateTimerDisplay()) {
                        // Timer zakończony
                        clearInterval(timerInterval);
                        
                        // Płynnie wycisz wszystkie dźwięki
                        fadeOutAllSounds(5000);
                        
                        // Usuń aktywne klasy z przycisków timera
                        timerButtons.forEach(btn => btn.classList.remove('active'));
                        
                        // Powiadomienie
                        showToast('Timer zakończony', 'Dźwięki zostały płynnie wyciszone.');
                        
                        // Powiadomienie przeglądarki (opcjonalnie)
                        if ('Notification' in window && Notification.permission === 'granted') {
                            new Notification('Śpij Słoneczko', {
                                body: 'Timer zakończony. Dźwięki zostały wyciszone.',
                                icon: '/favicon.ico'
                            });
                        }
                    }
                }, 1000);
                
                // Pokaż powiadomienie o ustawieniu timera
                showToast('Timer ustawiony', `Timer ustawiony na ${minutes} minut.`);
            }
            
            // Aktualizacja wyświetlania timera
            function updateTimerDisplay() {
                if (!timerEndTime || !timerStartTime) return false;
                
                const now = new Date();
                const diff = timerEndTime - now;
                
                // Jeśli timer się zakończył
                if (diff <= 0) {
                    timerDisplay.textContent = '00:00:00';
                    timerProgress.style.background = 'conic-gradient(var(--accent) 0deg, transparent 0deg)';
                    return false;
                }
                
                // Oblicz godziny, minuty, sekundy
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                
                // Formatuj wyświetlanie
                timerDisplay.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Aktualizuj wizualny wskaźnik
                const totalDuration = timerEndTime - timerStartTime;
                const elapsed = now - timerStartTime;
                const percentage = (elapsed / totalDuration) * 100;
                const degrees = (percentage / 100) * 360;
                
                timerProgress.style.background = 
                    `conic-gradient(var(--accent) ${degrees}deg, transparent ${degrees}deg)`;
                
                return true;
            }
            
            // =========== ROZBUDOWANE ĆWICZENIA RELAKSACYJNE ===========
            // Zmienne dla ćwiczeń oddechowych
            const breathingCircle = document.getElementById('breathing-circle');
            const breathingText = document.getElementById('breathing-text');
            const breathingDescription = document.getElementById('breathing-description');
            const startBreathingBtn = document.getElementById('start-breathing-btn');
            let breathingInterval = null;
            let currentBreathingType = '478'; // domyślnie 4-7-8
            
            // Definicje ćwiczeń oddechowych
            const breathingTypes = {
                '478': {
                    description: 'Technika 4-7-8 pomaga zrelaksować się i przygotować do snu',
                    phases: [
                        { name: 'inhale', text: 'Wdech', duration: 4000 },
                        { name: 'hold', text: 'Zatrzymaj', duration: 7000 },
                        { name: 'exhale', text: 'Wydech', duration: 8000 }
                    ]
                },
                'box': {
                    description: 'Oddychanie kwadratowe 4-4-4-4 pomaga uspokoić umysł i znaleźć równowagę',
                    phases: [
                        { name: 'box-inhale', text: 'Wdech', duration: 4000 },
                        { name: 'box-hold1', text: 'Zatrzymaj', duration: 4000 },
                        { name: 'box-exhale', text: 'Wydech', duration: 4000 },
                        { name: 'box-hold2', text: 'Zatrzymaj', duration: 4000 }
                    ]
                },
                'diaphragm': {
                    description: 'Oddychanie przeponowe głęboko dotlenia organizm i pomaga się zrelaksować',
                    phases: [
                        { name: 'inhale', text: 'Głęboki wdech przeponą', duration: 5000 },
                        { name: 'exhale', text: 'Powolny, pełny wydech', duration: 7000 }
                    ]
                }
            };
            
            // Funkcja rozpoczynająca ćwiczenie oddechowe
            function startBreathingExercise() {
                // Zatrzymaj istniejący interwał jeśli istnieje
                if (breathingInterval) {
                    clearInterval(breathingInterval);
                    breathingCircle.className = 'breathing-circle';
                    breathingText.textContent = 'Kliknij, aby rozpocząć';
                    startBreathingBtn.textContent = 'Rozpocznij ćwiczenie';
                    return;
                }
                
                const exerciseConfig = breathingTypes[currentBreathingType];
                let phase = 0;
                const phases = exerciseConfig.phases;
                
                function updateBreathingPhase() {
                    const currentPhase = phases[phase];
                    
                    // Usuń wszystkie klasy animacji
                    breathingCircle.className = 'breathing-circle';
                    
                    // Dodaj nową klasę animacji
                    setTimeout(() => {
                        breathingCircle.classList.add(currentPhase.name);
                        breathingText.textContent = currentPhase.text;
                    }, 10);
                    
                    // Przejdź do następnej fazy
                    phase = (phase + 1) % phases.length;
                    
                    // Ustaw timeout dla następnej fazy
                    breathingInterval = setTimeout(updateBreathingPhase, currentPhase.duration);
                }
                
                // Rozpocznij od pierwszej fazy
                updateBreathingPhase();
                
                // Zmień tekst przycisku
                startBreathingBtn.textContent = 'Zatrzymaj ćwiczenie';
            }
            
            // Obsługa przycisków wyboru techniki oddechowej
            document.querySelectorAll('.exercise-tab[data-breathing]').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Zatrzymaj aktualne ćwiczenie
                    if (breathingInterval) {
                        clearInterval(breathingInterval);
                        breathingInterval = null;
                        breathingCircle.className = 'breathing-circle';
                        breathingText.textContent = 'Kliknij, aby rozpocząć';
                        startBreathingBtn.textContent = 'Rozpocznij ćwiczenie';
                    }
                    
                    // Ustaw nowy typ oddychania
                    currentBreathingType = this.dataset.breathing;
                    
                    // Aktualizuj opis
                    breathingDescription.textContent = breathingTypes[currentBreathingType].description;
                    
                    // Aktualizuj aktywny przycisk
                    document.querySelectorAll('.exercise-tab[data-breathing]').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
            
            // Obsługa przycisku ćwiczenia oddechowego
            startBreathingBtn.addEventListener('click', function() {
                if (this.textContent.includes('Rozpocznij')) {
                    startBreathingExercise();
                } else {
                    if (breathingInterval) {
                        clearInterval(breathingInterval);
                        breathingInterval = null;
                    }
                    breathingCircle.className = 'breathing-circle';
                    breathingText.textContent = 'Kliknij, aby rozpocząć';
                    this.textContent = 'Rozpocznij ćwiczenie';
                }
            });
            
            // Umożliwienie kliknięcia bezpośrednio na kółko
            breathingCircle.addEventListener('click', function() {
                startBreathingBtn.click();
            });
            
            // =========== PROGRESYWNA RELAKSACJA MIĘŚNI ===========
            const muscleGroups = document.querySelectorAll('.muscle-group');
            const startMuscleBtn = document.getElementById('start-muscle-relaxation');
            const muscleProgress = document.getElementById('muscle-progress');
            let muscleRelaxationInterval = null;
            let currentMuscleGroup = 0;
            
            // Obsługa kliknięć w grupy
            // Obsługa kliknięć w grupy mięśniowe
            muscleGroups.forEach(group => {
                group.addEventListener('click', function() {
                    // Przełącz widoczność instrukcji
                    const instruction = this.querySelector('.muscle-instruction');
                    instruction.classList.toggle('visible');
                    
                    // Przełącz stan aktywny grupy
                    this.classList.toggle('active');
                });
            });
            
            // Funkcja prowadząca przez pełne ćwiczenie relaksacji mięśniowej
            function startMuscleRelaxation() {
                // Zatrzymanie istniejącego ćwiczenia
                if (muscleRelaxationInterval) {
                    clearInterval(muscleRelaxationInterval);
                    muscleRelaxationInterval = null;
                    startMuscleBtn.textContent = 'Rozpocznij pełne ćwiczenie';
                    muscleGroups.forEach(group => {
                        group.classList.remove('active');
                        group.querySelector('.muscle-instruction').classList.remove('visible');
                    });
                    muscleProgress.style.width = '0%';
                    return;
                }
                
                // Przygotuj wszystkie grupy
                muscleGroups.forEach(group => {
                    group.classList.remove('active');
                    group.querySelector('.muscle-instruction').classList.remove('visible');
                });
                
                currentMuscleGroup = 0;
                startMuscleBtn.textContent = 'Zatrzymaj ćwiczenie';
                
                // Funkcja przechodząca przez poszczególne grupy mięśniowe
                function goToNextMuscleGroup() {
                    // Zakończ ćwiczenie po przejściu przez wszystkie grupy
                    if (currentMuscleGroup >= muscleGroups.length) {
                        clearInterval(muscleRelaxationInterval);
                        muscleRelaxationInterval = null;
                        startMuscleBtn.textContent = 'Rozpocznij pełne ćwiczenie';
                        
                        // Pokaż powiadomienie o zakończeniu
                        showToast('Ćwiczenie zakończone', 'Gratulacje! Ukończyłeś/aś ćwiczenie relaksacji mięśni.');
                        
                        // Resetuj grupy mięśniowe
                        muscleGroups.forEach(group => {
                            group.classList.remove('active');
                            group.querySelector('.muscle-instruction').classList.remove('visible');
                        });
                        return;
                    }
                    
                    // Aktualizuj pasek postępu
                    const progressPercentage = (currentMuscleGroup / muscleGroups.length) * 100;
                    muscleProgress.style.width = `${progressPercentage}%`;
                    
                    // Usuń aktywną klasę ze wszystkich grup
                    muscleGroups.forEach(group => {
                        group.classList.remove('active');
                        group.querySelector('.muscle-instruction').classList.remove('visible');
                    });
                    
                    // Aktywuj bieżącą grupę
                    const currentGroup = muscleGroups[currentMuscleGroup];
                    currentGroup.classList.add('active');
                    currentGroup.querySelector('.muscle-instruction').classList.add('visible');
                    
                    // Przewiń do aktywnej grupy
                    currentGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Przejdź do następnej grupy po 20 sekundach (5s napięcie + 15s relaks)
                    currentMuscleGroup++;
                    
                    // Pokaż powiadomienie
                    if (currentMuscleGroup <= muscleGroups.length) {
                        const groupName = currentGroup.querySelector('h4').textContent;
                        showToast('Grupa mięśniowa', groupName);
                    }
                }
                
                // Rozpocznij od pierwszej grupy
                goToNextMuscleGroup();
                
                // Ustaw interwał 20 sekund między grupami
                muscleRelaxationInterval = setInterval(goToNextMuscleGroup, 20000);
            }
            
            // Obsługa przycisku rozpoczęcia ćwiczenia relaksacji mięśni
            startMuscleBtn.addEventListener('click', startMuscleRelaxation);
            
            // =========== WIZUALIZACJE RELAKSACYJNE ===========
            const visualizationScene = document.getElementById('visualization-scene');
            let visualizationText = document.getElementById('visualization-text');
            const startVisualizationBtn = document.getElementById('start-visualization');
            let visualizationInterval = null;
            let currentScene = 'beach'; // domyślna scena
            
            // Teksty dla różnych scen wizualizacji
            const visualizationScenes = {
                'beach': [
                    'Wyobraź sobie, że leżysz na ciepłej, miękkiej plaży. Czujesz delikatne ciepło słońca na swojej skórze.',
                    'Fale rytmicznie uderzają o brzeg, tworząc uspokajający szum. Wdychasz świeży, morski zapach.',
                    'Z każdym oddechem czujesz się coraz bardziej zrelaksowany/a. Twoje ciało powoli zanurza się w miękkim piasku.',
                    'Niebo nad tobą jest błękitne, z kilkoma puszystymi chmurami. Słyszysz odległe krzyki mew.',
                    'Twoje mięśnie się rozluźniają, a umysł uspokaja. Pozwól sobie na całkowite odprężenie w tym spokojnym miejscu.'
                ],
                'forest': [
                    'Znajdujesz się w pięknym, starym lesie. Otaczają cię wysokie drzewa, a ich liście szumią delikatnie na wietrze.',
                    'Promienie słońca przebijają się przez korony drzew, tworząc ciepłe plamy światła na ścieżce przed tobą.',
                    'Słyszysz śpiew ptaków i delikatny szelest liści. Powietrze jest świeże i pełne zapachu żywicy.',
                    'Z każdym krokiem zagłębiasz się dalej w las, czując spokój i harmonię tego miejsca.',
                    'Znajdujesz miękkie, mchowe miejsce, gdzie możesz usiąść lub położyć się. Czujesz, jak cały stres opuszcza twoje ciało.'
                ],
                'sky': [
                    'Leżysz na miękkim kocu i patrzysz w nocne niebo pełne gwiazd. Nad tobą rozciąga się nieskończony kosmos.',
                    'Gwiazdy migoczą delikatnie, a ty dostrzegasz znane konstelacje i jasny sierp księżyca.',
                    'Powietrze jest chłodne i rześkie. Z każdym oddechem czujesz, jak twój umysł się uspokaja.',
                    'Twoje ciało staje się lekkie, niemal jakbyś mógł/mogła unosić się wśród gwiazd. Grawitacja zdaje się słabnąć.',
                    'Problemy i zmartwienia maleją, stają się małe jak drobne punkty na niebie. Czujesz głęboki spokój i połączenie z wszechświatem.'
                ]
            };
            
            // Funkcja zmieniająca scenę wizualizacji
            function changeVisualizationScene(sceneName) {
                // Usuń wszystkie klasy scen i dodaj odpowiednią
                visualizationScene.className = 'visualization-scene';
                visualizationScene.classList.add(`visualization-${sceneName}`);
                
                // Dodaj lub usuń elementy specyficzne dla sceny
                visualizationScene.innerHTML = '';
                
                if (sceneName === 'beach') {
                    // Dodaj fale dla plaży
                    for (let i = 0; i < 3; i++) {
                        const wave = document.createElement('div');
                        wave.className = 'wave';
                        visualizationScene.appendChild(wave);
                    }
                }
                
                // Dodaj overlay z tekstem
                const overlay = document.createElement('div');
                overlay.className = 'visualization-overlay';
                overlay.innerHTML = `<p class="visualization-text" id="visualization-text">${visualizationScenes[sceneName][0]}</p>`;
                visualizationScene.appendChild(overlay);
                
                // Aktualizuj referencję do elementu tekstu
                visualizationText = document.querySelector('#visualization-text');
            }
            
            // Funkcja rozpoczynająca wizualizację
            function startVisualization() {
                // Zatrzymaj istniejącą wizualizację jeśli istnieje
                if (visualizationInterval) {
                    clearInterval(visualizationInterval);
                    visualizationInterval = null;
                    startVisualizationBtn.textContent = 'Rozpocznij wizualizację';
                    return;
                }
                
                startVisualizationBtn.textContent = 'Zatrzymaj wizualizację';
                
                let currentTextIndex = 0;
                const texts = visualizationScenes[currentScene];
                
                // Funkcja aktualizująca tekst wizualizacji
                function updateVisualizationText() {
                    // Płynna zmiana tekstu
                    visualizationText.style.opacity = '0';
                    
                    setTimeout(() => {
                        visualizationText.textContent = texts[currentTextIndex];
                        visualizationText.style.opacity = '1';
                        
                        // Przejdź do następnego tekstu
                        currentTextIndex = (currentTextIndex + 1) % texts.length;
                    }, 500);
                }
                
                // Rozpocznij od pierwszego tekstu
                updateVisualizationText();
                
                // Ustaw interwał do zmiany tekstów co 10 sekund
                visualizationInterval = setInterval(updateVisualizationText, 10000);
            }
            
            // Obsługa przycisków wyboru sceny wizualizacji
            document.querySelectorAll('.visualization-scene-tabs .exercise-tab[data-scene]').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Zatrzymaj aktualną wizualizację
                    if (visualizationInterval) {
                        clearInterval(visualizationInterval);
                        visualizationInterval = null;
                        startVisualizationBtn.textContent = 'Rozpocznij wizualizację';
                    }
                    
                    // Ustaw nową scenę
                    currentScene = this.dataset.scene;
                    changeVisualizationScene(currentScene);
                    
                    // Aktualizuj aktywny przycisk
                    document.querySelectorAll('.visualization-scene-tabs .exercise-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
            
            // Obsługa przycisku rozpoczęcia wizualizacji
            startVisualizationBtn.addEventListener('click', startVisualization);
            
            // =========== BAJKI NA DOBRANOC ===========
            // Obsługa akordeonu z bajkami
            const storyHeaders = document.querySelectorAll('.story-header');
            
            storyHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const storyId = this.dataset.story;
                    const content = document.getElementById(`${storyId}-story`);
                    
                    // Przełącz widoczność zawartości
                    content.classList.toggle('visible');
                    
                    // Przełącz stan aktywny nagłówka
                    this.classList.toggle('active');
                    
                    // Zamknij inne otwarte bajki
                    storyHeaders.forEach(otherHeader => {
                        if (otherHeader !== this && otherHeader.classList.contains('active')) {
                            otherHeader.classList.remove('active');
                            const otherId = otherHeader.dataset.story;
                            document.getElementById(`${otherId}-story`).classList.remove('visible');
                        }
                    });
                });
            });
            
            // Obsługa głównych zakładek ćwiczeń
            document.querySelectorAll('.exercise-tab[data-tab]').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    
                    // Ukryj wszystkie treści ćwiczeń
                    document.querySelectorAll('.exercise-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Pokaż wybraną treść
                    document.getElementById(`${tabName}-content`).classList.add('active');
                    
                    // Aktualizuj aktywny przycisk
                    document.querySelectorAll('.exercise-tab[data-tab]').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Zatrzymaj wszystkie aktywne ćwiczenia
                    if (breathingInterval) {
                        clearInterval(breathingInterval);
                        breathingInterval = null;
                        breathingCircle.className = 'breathing-circle';
                        breathingText.textContent = 'Kliknij, aby rozpocząć';
                        startBreathingBtn.textContent = 'Rozpocznij ćwiczenie';
                    }
                    
                    if (muscleRelaxationInterval) {
                        clearInterval(muscleRelaxationInterval);
                        muscleRelaxationInterval = null;
                        startMuscleBtn.textContent = 'Rozpocznij pełne ćwiczenie';
                        muscleGroups.forEach(group => {
                            group.classList.remove('active');
                            group.querySelector('.muscle-instruction').classList.remove('visible');
                        });
                        muscleProgress.style.width = '0%';
                    }
                    
                    if (visualizationInterval) {
                        clearInterval(visualizationInterval);
                        visualizationInterval = null;
                        startVisualizationBtn.textContent = 'Rozpocznij wizualizację';
                    }
                });
            });
            
            // =========== NASŁUCHIWACZE ZDARZEŃ ===========
            
            // Nasłuchiwacze zdarzeń dla przycisków dźwięku
            soundButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const soundName = this.dataset.sound;
                    playSound(soundName);
                });
            });
            
            // Nasłuchiwacze zdarzeń dla suwaka głośności głównej
            volumeSlider.addEventListener('input', function() {
                const value = parseFloat(this.value);
                for (const audio of activeSounds.values()) {
                    audio.volume = value;
                }
                
                // Aktualizuj wszystkie suwaki indywidualnej głośności
                document.querySelectorAll('.individual-volume').forEach(slider => {
                    slider.value = value;
                });
            });
            
            // Nasłuchiwacze zdarzeń dla przycisków timera
            timerButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const minutes = parseInt(this.dataset.time);
                    setTimer(minutes);
                });
            });
            
            // Nasłuchiwacz dla niestandardowego timera
            customTimerBtn.addEventListener('click', function() {
                const minutes = parseInt(customTimerInput.value);
                if (isNaN(minutes) || minutes <= 0 || minutes > 480) {
                    showToast('Błąd', 'Wprowadź wartość między 1 a 480 minut.');
                    return;
                }
                setTimer(minutes);
                
                // Wyczyść pole input
                customTimerInput.value = '';
            });
            
            // Obsługa Enter w polu niestandardowego timera
            customTimerInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    customTimerBtn.click();
                }
            });
            
            // Obsługa zapisywania preferencji
            document.getElementById('save-preferences').addEventListener('click', function(e) {
                e.preventDefault();
                
                // Zapisz preferencje w localStorage
                const preferences = {
                    volume: volumeSlider.value,
                    theme: document.body.classList.contains('light-mode') ? 'light' : 'dark',
                    activeSounds: Array.from(activeSounds.keys())
                };
                
                localStorage.setItem('spijSloneczko-preferences', JSON.stringify(preferences));
                showToast('Zapisano', 'Twoje preferencje zostały zapisane!');
            });
            
            // Ładowanie zapisanych preferencji
            function loadSavedPreferences() {
                const savedPrefs = localStorage.getItem('spijSloneczko-preferences');
                if (!savedPrefs) return;
                
                try {
                    const preferences = JSON.parse(savedPrefs);
                    
                    // Ustaw głośność
                    if (preferences.volume) {
                        volumeSlider.value = preferences.volume;
                    }
                    
                    // Ustaw motyw (już obsłużone wcześniej)
                    
                    // Odtwórz zapisane dźwięki
                    if (preferences.activeSounds && Array.isArray(preferences.activeSounds)) {
                        preferences.activeSounds.forEach(sound => {
                            setTimeout(() => {
                                playSound(sound);
                            }, 500);
                        });
                    }
                    
                } catch (error) {
                    console.error('Błąd podczas wczytywania preferencji:', error);
                }
            }
            
            // Sprawdzenie dostępności plików dźwiękowych
            function checkSoundFiles() {
                Object.entries(sounds).forEach(([name, path]) => {
                    const testAudio = new Audio();
                    testAudio.addEventListener('error', () => {
                        console.warn(`Plik dźwiękowy "${path}" dla "${name}" nie został znaleziony.`);
                    });
                    testAudio.src = path;
                });
            }
            
            // Zapytanie o pozwolenie na powiadomienia
            if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
            
            // Wczytaj preferencje po załadowaniu strony
            setTimeout(() => {
                loadSavedPreferences();
                checkSoundFiles();
            }, 1000);
        });
        // ========== GENERATOR BAJEK NA DOBRANOC ==========

// Konfiguracja zewnętrznego API
// Konfiguracja zewnętrznego API
const STORY_API_CONFIG = {
    // Ustawienia API dla OpenRouter
    openrouter: {
        apiKey: '',
        endpoint: 'https://openrouter.ai/api/v1/chat/completions',
        model: 'deepseek/deepseek-chat-v3-0324:free', // Model DeepSeek dla płynnej generacji bajek
        maxTokens: 1600,
        temperature: 0.7,
        referer: window.location.origin, // Dynamiczne pobieranie URL strony
        siteTitle: 'Śpij Słoneczko',
        enabled: true // Czy API jest włączone
    },
    
    // Dodatkowe ustawienia systemu
    settings: {
        useExternalApi: true, // Czy używać zewnętrznego API
        fallbackToLocal: true, // Czy używać lokalnego generatora jako awaryjnego
        maxStoriesToKeep: 10, // Maksymalna liczba bajek do przechowywania
        checkNewStoryOnLoad: true // Czy sprawdzać automatycznie przy ładowaniu strony
    }
};

// Define a function to get the prompt directly - funkcja zwracająca prompt
function getStoryPrompt() {
    return `Napisz oryginalną, uspokajającą bajkę na dobranoc, przeznaczoną dla dziewczyny. Bajka powinna składać się z około 10 akapitów i zawierać następujące dwie postacie (w każdej bajce muszą wystąpić obie postacie, choć mogą być przedstawione w symboliczny sposób):
 Renatka lub Słoneczko – główna bohaterka, dziewczynka,
 Sławuś lub Dziubasek – jej przyjaciel i opiekun.
 
 Charakter bajki:
 Nastrój bajki ma być magiczny i kojący, idealny do zasypiania.
 W treści powinny pojawić się motywy związane z niebem, gwiazdami, chmurami, lasem lub morzem.
 Bajka powinna podkreślać wartości takie jak miłość, przyjaźń, troska i opiekuńczość.
 Zakończenie bajki musi być spokojne i pozytywne.
 Unikaj wprowadzania strasznych postaci oraz elementów budzących niepokój.
 
 Dodatkowy wymóg:
 Tytuł bajki musi być ciekawy zachęcający.
         
         Odpowiedź sformatuj jako JSON z polami:
         - title: tytuł bajki
         - icon: wybierz ikonę (star, moon, cloud, tree, heart)
         - content: treść bajki podzielona na akapity (używaj podwójnych znaków nowej linii między akapitami)`;
}

// Manager Klucza API dla OpenRouter - musi być przed bajkiGenerator
const ApiKeyManager = {
    // Klucz do przechowywania klucza API w localStorage
    STORAGE_KEY: 'openrouter-api-key',
    
    // Pobierz klucz API z localStorage
    getApiKey: function() {
        return localStorage.getItem(this.STORAGE_KEY);
    },
    
    // Zapisz klucz API w localStorage
    saveApiKey: function(apiKey) {
        localStorage.setItem(this.STORAGE_KEY, apiKey);
    },
    
    // Usuń klucz API z localStorage
    removeApiKey: function() {
        localStorage.removeItem(this.STORAGE_KEY);
    },
    
    // Sprawdź czy klucz API jest zapisany
    hasApiKey: function() {
        return !!this.getApiKey();
    },
    
    // Dodaj UI do zarządzania kluczem API w sekcji bajek
    addApiKeyUI: function() {
        const storiesContent = document.getElementById('stories-content');
        if (!storiesContent) return;
        
        // Sprawdź czy element istnieje już w DOM
        if (document.getElementById('api-key-manager')) return;
        
        // Utwórz kontener na UI zarządzania kluczem API
        const apiKeyManager = document.createElement('div');
        apiKeyManager.id = 'api-key-manager';
        apiKeyManager.className = 'mb-4 mt-3 p-3';
        
        // Dodaj stylizację dostosowaną do ciemnego tła
        apiKeyManager.style.backgroundColor = 'var(--primary-light)';
        apiKeyManager.style.borderRadius = 'var(--radius-md)';
        apiKeyManager.style.boxShadow = 'var(--shadow-sm)';
        apiKeyManager.style.borderLeft = '4px solid var(--accent)';
        
        // Dodaj tytuł
        const title = document.createElement('h5');
        title.innerHTML = '<i class="fas fa-key"></i> Klucz API OpenRouter';
        title.className = 'mb-2';
        title.style.color = 'var(--accent)'; // Używa koloru akcentowego do lepszej widoczności
        apiKeyManager.appendChild(title);
        
        // Dodaj opis
        const description = document.createElement('p');
        description.className = 'small mb-3';
        description.textContent = 'Aby generować bajki przy użyciu AI, wprowadź swój klucz API OpenRouter. Klucz jest przechowywany tylko na twoim urządzeniu.';
        description.style.color = 'var(--text-light)';  // Użyj zmiennej koloru tekstu
        apiKeyManager.appendChild(description);
        
        // Utwórz kontener na input i przyciski
        const inputGroup = document.createElement('div');
        inputGroup.className = 'd-flex flex-wrap gap-2 align-items-center mb-2';
        
        // Input na klucz API
        const apiKeyInput = document.createElement('input');
        apiKeyInput.type = 'password';
        apiKeyInput.id = 'api-key-input';
        apiKeyInput.className = 'form-control flex-grow-1';
        apiKeyInput.placeholder = 'Wprowadź klucz API OpenRouter';
        apiKeyInput.value = this.getApiKey() || '';
        
        // Stylizacja pola wprowadzania
        apiKeyInput.style.backgroundColor = 'var(--primary-medium)';
        apiKeyInput.style.color = 'var(--text-light)';
        apiKeyInput.style.border = '2px solid var(--accent-transparent-medium)';
        apiKeyInput.style.padding = '0.5rem';
        apiKeyInput.style.borderRadius = 'var(--radius-sm)';
        
        inputGroup.appendChild(apiKeyInput);
        
        // Przycisk do zapisania klucza
        const saveButton = document.createElement('button');
        saveButton.className = 'sound-btn';
        saveButton.innerHTML = '<i class="fas fa-save"></i> Zapisz';
        saveButton.addEventListener('click', () => {
            const apiKey = apiKeyInput.value.trim();
            if (apiKey) {
                this.saveApiKey(apiKey);
                // Aktualizuj konfigurację API
                STORY_API_CONFIG.openrouter.apiKey = apiKey;
                // Pokaż powiadomienie
                const toastEl = document.getElementById('app-toast');
                if (toastEl) {
                    document.getElementById('toast-title').textContent = 'Klucz API zapisany';
                    document.getElementById('toast-message').textContent = 'Twój klucz API został zapisany lokalnie.';
                    const toast = new bootstrap.Toast(toastEl);
                    toast.show();
                }
                // Aktualizuj status
                updateStatusIndicator();
            }
        });
        inputGroup.appendChild(saveButton);
        
        // Przycisk do usunięcia klucza
        const removeButton = document.createElement('button');
        removeButton.className = 'sound-btn';
        removeButton.innerHTML = '<i class="fas fa-trash"></i> Usuń';
        removeButton.addEventListener('click', () => {
            this.removeApiKey();
            apiKeyInput.value = '';
            // Aktualizuj konfigurację API
            STORY_API_CONFIG.openrouter.apiKey = '';
            // Pokaż powiadomienie
            const toastEl = document.getElementById('app-toast');
            if (toastEl) {
                document.getElementById('toast-title').textContent = 'Klucz API usunięty';
                document.getElementById('toast-message').textContent = 'Twój klucz API został usunięty.';
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
            // Aktualizuj status
            updateStatusIndicator();
        });
        inputGroup.appendChild(removeButton);
        
        // Przycisk pokaż/ukryj hasło
        const toggleButton = document.createElement('button');
        toggleButton.className = 'sound-btn';
        toggleButton.innerHTML = '<i class="fas fa-eye"></i>';
        toggleButton.title = 'Pokaż/ukryj klucz API';
        toggleButton.addEventListener('click', () => {
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleButton.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                apiKeyInput.type = 'password';
                toggleButton.innerHTML = '<i class="fas fa-eye"></i>';
            }
        });
        inputGroup.appendChild(toggleButton);
        
        apiKeyManager.appendChild(inputGroup);
        
        // Dodaj link do OpenRouter i status klucza API
        const statusContainer = document.createElement('div');
        statusContainer.className = 'mt-2 d-flex justify-content-between align-items-center';
        
        // Link do OpenRouter
        const linkContainer = document.createElement('div');
        linkContainer.className = 'small';
        linkContainer.innerHTML = 'Nie masz klucza API? <a href="https://openrouter.ai" target="_blank" rel="noopener" style="color: var(--accent);">Utwórz konto na OpenRouter</a>';
        statusContainer.appendChild(linkContainer);
        
        // Status klucza API
        const statusIndicator = document.createElement('div');
        statusIndicator.id = 'api-key-status';
        statusIndicator.className = 'small d-flex align-items-center';
        
        // Funkcja do aktualizacji wskaźnika statusu
        const updateStatusIndicator = () => {
            const hasKey = this.hasApiKey();
            statusIndicator.innerHTML = '';
            
            const statusDot = document.createElement('span');
            statusDot.style.width = '10px';
            statusDot.style.height = '10px';
            statusDot.style.borderRadius = '50%';
            statusDot.style.marginRight = '6px';
            statusDot.style.backgroundColor = hasKey ? '#4caf50' : '#f44336'; // zielony/czerwony
            
            const statusText = document.createElement('span');
            statusText.textContent = hasKey ? 'Klucz API skonfigurowany' : 'Brak klucza API';
            
            statusIndicator.appendChild(statusDot);
            statusIndicator.appendChild(statusText);
        };
        
        // Inicjalizacja statusu
        updateStatusIndicator();
        
        statusContainer.appendChild(statusIndicator);
        
        apiKeyManager.appendChild(statusContainer);
        
        // Dodaj do DOM
        const bedtimeStories = storiesContent.querySelector('.bedtime-stories');
        if (bedtimeStories) {
            storiesContent.insertBefore(apiKeyManager, bedtimeStories);
        } else {
            storiesContent.appendChild(apiKeyManager);
        }
        
        // Aktualizuj konfigurację API, jeśli klucz istnieje
        if (this.hasApiKey()) {
            STORY_API_CONFIG.openrouter.apiKey = this.getApiKey();
        }
    }
};

// Ustaw klucz API z localStorage
STORY_API_CONFIG.openrouter.apiKey = ApiKeyManager.getApiKey() || '';

// Główny obiekt generatora bajek
const bajkiGenerator = {
    // Sprawdza czy należy wygenerować nową bajkę
    shouldGenerateNewStory: function() {
        const lastGenerationDate = localStorage.getItem('lastStoryGenerationDate');
        
        // Jeśli nie ma zapisanej daty, oznacza to, że należy wygenerować bajkę
        if (!lastGenerationDate) {
            return true;
        }
        
        // Sprawdź czy minął przynajmniej jeden dzień od ostatniego generowania
        const lastDate = new Date(lastGenerationDate);
        const currentDate = new Date();
        
        // Resetujemy godziny, minuty, sekundy aby porównać tylko daty
        lastDate.setHours(0, 0, 0, 0);
        currentDate.setHours(0, 0, 0, 0);
        
        // Oblicz różnicę w dniach
        const diffTime = currentDate.getTime() - lastDate.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        return diffDays >= 1;
    },
    
    // Pobiera zapisane bajki z localStorage
    getSavedStories: function() {
        const savedStories = localStorage.getItem('generatedStories');
        return savedStories ? JSON.parse(savedStories) : [];
    },
    
    // Zapisuje nową bajkę do localStorage
    saveStory: function(story) {
        const savedStories = this.getSavedStories();
        savedStories.push(story);
        
        // Zapisz bajki i datę generowania
        localStorage.setItem('generatedStories', JSON.stringify(savedStories));
        localStorage.setItem('lastStoryGenerationDate', new Date().toISOString());
    },
    
    // Lista predefiniowanych szablonów bajek (do użycia w trybie lokalnym)
    storyTemplates: [
        {
            title: "Renatka i Zaczarowany Las",
            icon: "tree",
            generate: function() {
                return [
                    `Dawno, dawno temu, na skraju wielkiego, gęstego lasu mieszkała dziewczynka o imieniu Renatka. Renatka zawsze była ciekawa, co kryje się w najgłębszych zakamarkach tego lasu, którego dorośli często unikali.`,
                    `Pewnego spokojnego wieczoru, gdy gwiazdy zaczęły już migotać na niebie, Renatka usłyszała delikatny głos dochodzący z kierunku drzew. "Przyjdź... przyjdź do nas..." - szeptał głos melodyjnie.`,
                    `Wiedziona ciekawością, Renatka wymknęła się z domu i podążyła w kierunku lasu. Z każdym krokiem drzewa stawały się wyższe, a światło księżyca tańczyło wśród liści, tworząc magiczne wzory na ścieżce.`,
                    `Nagle, na małej polance, Renatka zobaczyła małego, świecącego ptaszka o niezwykle mądrych oczach. "Witaj Renatko," powiedział ptaszek. "Jestem Dziubasek, opiekun tego lasu i jego skarbów."`,
                    `"Dziubasku," zapytała zdziwiona Renatka, "czy to ty mnie wołałeś?" Mądry ptaszek pokiwał głową i odparł: "Las cię wybrał, Renatko. Od dawna obserwuję twoją dobroć i czystość serca. Potrzebujemy twojej pomocy."`,
                    `Dziubasek opowiedział Renatce, że las powoli traci swoją magię, ponieważ ludzie zapomnieli o radości, jaką daje kontakt z naturą. "Tylko ktoś, kto kocha naturę tak jak ty, może przywrócić magię," wyjaśnił Dziubasek.`,
                    `Z pomocą Dziubaska, Renatka przemierzała zakątki lasu, rozmawiając z każdym drzewem, kwiatem i zwierzęciem, przypominając im o miłości, która je łączy. Z każdą taką rozmową, las stawał się jaśniejszy, a jego kolory żywsze.`,
                    `"To działa!" zawołał radośnie Dziubasek, kiedy zobaczył, jak małe świetliste iskierki zaczynają unosić się z każdego miejsca, które odwiedziła Renatka. "Twoja miłość i troska przywracają magię!"`,
                    `Gdy nastał świt, Renatka musiała wrócić do domu. "Będę tęsknić, Dziubasku," powiedziała ze smutkiem. Mądry ptaszek usiadł na jej ramieniu. "Nie musisz tęsknić, Renatko. Teraz jestem twoim przyjacielem i będę przy tobie zawsze, gdy będziesz mnie potrzebować."`,
                    `I tak, dzięki przyjaźni Renatki i Dziubaska, las odzyskał swoją magię, a Renatka zyskała najwspanialszego przyjaciela, który czuwał nad jej snami każdej nocy, opowiadając jej historie o cudach natury, aż zasypiała z uśmiechem na twarzy.`
                ].join('\n\n');
            }
        },
        {
            title: "Renatka i Gwiaździste Niebo",
            icon: "moon",
            generate: function() {
                return [
                    `W małym domku z czerwonym dachem mieszkała dziewczynka o imieniu Renatka. Renatka miała problem - bardzo bała się ciemności i każdej nocy trudno jej było zasnąć, choć zmęczone oczka aż się zamykały.`,
                    `Pewnej wyjątkowej nocy, gdy księżyc był wyjątkowo jasny i okrągły, przez uchylone okno do pokoju Renatki wleciał mały, świecący punkcik. A potem drugi. I trzeci...`,
                    `Renatka z zaciekawieniem obserwowała, jak do pokoju wlatuje coraz więcej drobnych świetlików, które zaczęły tańczyć w powietrzu, tworząc różne kształty i obrazy. Nagle świetliki ułożyły się w kształt małego ptaszka.`,
                    `"Witaj, Renatko," usłyszała delikatny głos. "Jestem Dziubasek, strażnik nocnych snów. Przybywam do dzieci, które boją się ciemności, by pokazać im piękno nocy."`,
                    `Dziubasek, mieniący się delikatnym, niebieskim światłem, usiadł na brzegu łóżka Renatki. "Nie musisz bać się ciemności," powiedział łagodnie. "Ciemność to tylko miejsce, gdzie gwiazdy mogą pokazać swoje piękno."`,
                    `"Chcę ci coś pokazać," szepnął Dziubasek. "Zamknij oczy i podaj mi dłoń." Renatka, choć trochę niepewnie, zrobiła to, o co prosił świetlisty przyjaciel.`,
                    `W jednej chwili poczuła, jak unosi się w powietrzu. Gdy otworzyła oczy, zobaczyła, że lecą wysoko ponad dachami domów! "Dziubasku, latamy!" zawołała zdumiona Renatka. Jej strach zniknął, zastąpiony fascynacją.`,
                    `Dziubasek zabrał Renatkę w podróż po nocnym niebie. Pokazał jej, jak gwiazdy tworzą konstelacje - opowieści zapisane na niebie. Przedstawił jej Księżyc, który opowiedział, jak każdej nocy czuwa nad snem wszystkich dzieci.`,
                    `"Widzisz, Renatko," powiedział Dziubasek, gdy wracali do jej pokoju, "noc nie jest straszna. Jest pełna magii i piękna, tak jak dzień, tylko inaczej."`,
                    `Od tej nocy Renatka nie bała się już ciemności. A Dziubasek odwiedzał ją często, zabierając w kolejne podróże po gwiaździstym niebie. Nawet jeśli Dziubasek nie mógł przybyć, Renatka wiedziała, że wystarczy spojrzeć w niebo, by zobaczyć jego światło wśród gwiazd, czuwające nad jej spokojnym snem.`
                ].join('\n\n');
            }
        },
        {
            title: "Dziubasek i Podróż Małej Chmurki",
            icon: "cloud",
            generate: function() {
                return [
                    `Wysoko na niebie, pośród rozległego błękitu, żyła mała chmurka o imieniu Renatka. W przeciwieństwie do innych chmur, Renatka nigdy nie uroniła ani jednej kropli deszczu, gdyż bała się, że gdy odda swoją wodę, po prostu zniknie.`,
                    `"Co się stanie, gdy wszystkie moje krople spadną na ziemię?" - pytała siebie codziennie, obserwując, jak inne chmury z radością podlewały rośliny, napełniały strumyki i dawały orzeźwienie spragnionym.`,
                    `Pewnego dnia pojawił się mały ptaszek o imieniu Dziubasek, który potrafił latać wyżej niż wszystkie inne ptaki. Gdy zobaczył samotną chmurkę, podleciał do niej. "Dlaczego jesteś taka smutna?" - zapytał łagodnie.`,
                    `Renatka opowiedziała mu o swoim strachu. Dziubasek wysłuchał jej uważnie, a potem powiedział: "Każda kropla, którą dajesz ziemi, wraca do ciebie, gdy tylko słońce ją ogrzeje. To jest cykl życia, którego jesteś ważną częścią."`,
                    `Renatka nie do końca rozumiała, co miał na myśli, ale zaufała mu na tyle, by razem polecieć nad wyjątkowo suchym i spragnionym regionem, gdzie od miesięcy nie spadła ani jedna kropla deszczu.`,
                    `Poniżej Renatka zobaczyła zwiędłe kwiaty, spragnione zwierzęta i ludzi patrzących w niebo z nadzieją. Jej serce wypełniło się współczuciem, które było silniejsze niż strach.`,
                    `"Może oddam im tylko kilka kropelek," pomyślała. I tak, niepewnie, uwolniła swoje pierwsze krople, które spadły na ziemię jako delikatna mżawka. Dziubasek latał pod nią, obserwując z radością.`,
                    `Z każdą kolejną kroplą Renatka czuła coś niezwykłego - zamiast maleć, czuła się coraz lżejsza i szczęśliwsza. Widziała radość, jaką przynosiła, i to dawało jej siłę. "Dziubasku, miałeś rację!" - zawołała radośnie.`,
                    `Gdy oddała wszystkie swoje krople, stała się niewidoczna - ale nie zniknęła. Stała się lekkim, ciepłym powietrzem, które Dziubasek pomógł jej wznieść ku górze, zbierając po drodze parującą wodę ze stawów, rzek i mokrej trawy.`,
                    `Wkrótce Renatka znów była puszystą chmurką, pełną nowych kropel i nowego zrozumienia - im więcej dajemy innym, tym więcej otrzymujemy z powrotem. A Dziubasek został jej najlepszym przyjacielem, który towarzyszył jej w każdej podróży po błękitnym niebie, zawsze gotów dodać otuchy, gdy nadchodziły burzowe myśli.`
                ].join('\n\n');
            }
        },
        {
            title: "Renatka i Magiczna Poduszka Snów",
            icon: "star",
            generate: function() {
                return [
                    `W małym miasteczku, gdzie domy miały czerwone dachy, a wszystkie drzwi były pomalowane na niebiesko, mieszkała dziewczynka o imieniu Renatka. Renatka miała problem - nie potrafiła śnić kolorowych snów jak inne dzieci.`,
                    `Nocami, gdy wszyscy opowiadali o swoich przygodach w krainie snów, Renatka mogła tylko słuchać z zazdrością. Jej sny były jak puste, białe kartki - bez kolorów, bez przygód, bez magii.`,
                    `Pewnego wieczoru, gdy smutek Renatki był wyjątkowo głęboki, na parapecie jej okna przysiadł mały ptaszek o pięknych, mieniących się piórach. "Cześć, jestem Dziubasek," powiedział ptaszek, ku zdumieniu Renatki.`,
                    `"Jak to możliwe, że mówisz?" - zapytała Renatka. Dziubasek zaćwierkał radośnie: "W świecie snów wszystko jest możliwe. A ja przybywam właśnie z tego świata. Słyszałem, że masz problemy z kolorowymi snami."`,
                    `Dziubasek wyjaśnił Renatce, że jest strażnikiem snów i ma dla niej specjalny prezent. Z małej torby, której Renatka wcześniej nie zauważyła, wyciągnął maleńką poduszkę, nie większą od dłoni dziewczynki.`,
                    `"To Poduszka Snów," powiedział Dziubasek. "Została utkana z promieni księżyca i porannej rosy. Gdy położysz ją pod swoją poduszką, otworzy drzwi do krainy snów, gdzie będę na ciebie czekać każdej nocy."`,
                    `Tej nocy Renatka zrobiła, jak radził Dziubasek. Gdy tylko zasnęła, znalazła się na łące pełnej kwiatów, których kolory były intensywniejsze niż cokolwiek, co widziała na jawie. A obok niej stał Dziubasek, tym razem wielkości człowieka.`,
                    `"Witaj w Krainie Snów," powiedział z uśmiechem. "Tutaj będziemy przeżywać przygody każdej nocy." I tak zaczęła się ich wspólna podróż - latali na grzbietach smoków, nurkowali w głębinach oceanu pełnego świecących ryb, odwiedzali zamki zbudowane z chmur.`,
                    `Z każdą kolejną nocą sny Renatki stawały się coraz piękniejsze, a jej przyjaźń z Dziubaskiem coraz silniejsza. Pewnego ranka Renatka obudziła się i zauważyła, że magiczna poduszka zniknęła.`,
                    `Z początku się przestraszyła, ale gdy nadeszła noc, odkryła, że nie potrzebuje już magicznej poduszki. Dziubasek nauczył ją, jak odnaleźć drogę do Krainy Snów samodzielnie - wystarczyło zamknąć oczy i pomyśleć o nim z miłością. Bo największa magia nie mieszka w przedmiotach, ale w sercu, które wierzy i kocha.`
                ].join('\n\n');
            }
        },
        {
            title: "Renatka i Melodia Gwiazd",
            icon: "music",
            generate: function() {
                return [
                    `W małym domku na skraju lasu mieszkała dziewczynka o imieniu Renatka. Renatka kochała muzykę ponad wszystko, a jej śmiech brzmiał jak najsłodsza melodia, która sprawiała, że nawet ptaki milkły, by jej słuchać.`,
                    `Pewnego wieczoru, gdy niebo było wyjątkowo gwiaździste, Renatka siedziała na ganku, nuciła cichą melodię i patrzyła w niebo. Nagle zauważyła, że jedna z gwiazd migocze w rytm jej piosenki. Zdumiona, przestała nucić, a gwiazda również przestała mrugać.`,
                    `"To niemożliwe," pomyślała i zaczęła nucić znowu. Ku jej zdumieniu, gwiazda znów zaczęła migotać dokładnie w tym samym rytmie. Jeszcze bardziej zaskakujące było to, że gwiazda zaczęła się zbliżać, stając się coraz większa i jaśniejsza.`,
                    `Z bliższej odległości Renatka zobaczyła, że to, co wzięła za gwiazdę, było w rzeczywistości małym ptaszkiem, który świecił delikatnym, srebrzystym blaskiem. Ptaszek wylądował na poręczy ganku.`,
                    `"Witaj, Renatko," powiedział ptaszek. "Jestem Dziubasek, strażnik Melodii Gwiazd. Twoja muzyka przyciągnęła mnie z daleka, bo jest w niej coś wyjątkowego - echo Pierwotnej Melodii, którą gwiazdy śpiewają od początku czasu."`,
                    `Dziubasek wyjaśnił Renatce, że każda gwiazda na niebie śpiewa własną pieśń, a wszystkie razem tworzą harmonię, która utrzymuje wszechświat w równowadze. "Ale ostatnio niektóre gwiazdy zapomniały swoje melodie i zapadają w sen. Potrzebuję twojej pomocy, by je obudzić."`,
                    `Tej nocy Dziubasek zabrał Renatkę w niezwykłą podróż po nocnym niebie. Unosili się między gwiazdami, a Renatka śpiewała dla każdej uśpionej gwiazdy, przypominając jej zapomnianą melodię. Z każdą przebudzoną gwiazdą niebo stawało się jaśniejsze.`,
                    `"Masz dar, Renatko," powiedział Dziubasek, gdy wracali nad ranem. "Twój głos niesie nie tylko melodię, ale i miłość, która potrafi przebudzić nawet najgłębiej uśpione serca."`,
                    `Od tej nocy Renatka i Dziubasek spotykali się często. Choć nie każdej nocy mogli podróżować między gwiazdami, Dziubasek nauczył Renatkę rozpoznawać melodie gwiazd nawet z ziemi. Wystarczyło wsłuchać się sercem w nocną ciszę.`,
                    `I gdy inne dzieci bały się ciemności, Renatka czekała na nią z niecierpliwością. Bo wiedziała to, czego inni nie rozumieli - że noc nie jest ciemna, lecz pełna świetlistej muzyki, którą można usłyszeć, gdy się naprawdę słucha. A Dziubasek zawsze był blisko, by pomóc jej wsłuchać się w najpiękniejsze melodie wszechświata.`
                ].join('\n\n');
            }
        }
    ],
    
    // Generuje nową bajkę lokalnie
    generateNewStory: function() {
        // Losowo wybierz szablon
        const randomIndex = Math.floor(Math.random() * this.storyTemplates.length);
        const template = this.storyTemplates[randomIndex];
        
        // Lista imion do losowego wyboru (używana tylko dla dywersyfikacji)
        const names = ["Marek", "Ania", "Wojtek", "Zosia", "Kuba", "Julka", "Bartek", "Klara", 
                        "Filip", "Emilka", "Olek", "Hania", "Mikołaj", "Tosia", "Igor", "Natalka"];
        const randomName = names[Math.floor(Math.random() * names.length)];
        
        // Wygeneruj treść bajki
        const storyContent = template.generate(randomName);
        
        // Utwórz obiekt bajki
        const newStory = {
            id: 'story-' + Date.now(),
            title: template.title.replace(/Zuzia|Tomek|Maja|Oliver|Lena/, randomName),
            icon: template.icon,
            content: storyContent,
            dateGenerated: new Date().toISOString(),
            source: 'local'
        };
        
        return newStory;
    },
    
    // Tworzy element DOM dla nowej bajki
    createStoryElement: function(story) {
        // Utwórz główny kontener bajki
        const storyAccordion = document.createElement('div');
        storyAccordion.className = 'story-accordion';
        
        // Utwórz nagłówek
        const storyHeader = document.createElement('div');
        storyHeader.className = 'story-header';
        storyHeader.setAttribute('data-story', story.id);
        
        // Dodaj tytuł z ikoną
        const storyTitle = document.createElement('h4');
        storyTitle.innerHTML = `<i class="fas fa-${story.icon} tip-icon"></i> ${story.title}`;
        
        // Dodaj ikonę strzałki
        const storyToggleIcon = document.createElement('i');
        storyToggleIcon.className = 'fas fa-chevron-down story-toggle-icon';
        
        // Dodaj elementy do nagłówka
        storyHeader.appendChild(storyTitle);
        storyHeader.appendChild(storyToggleIcon);
        
        // Utwórz kontener treści
        const storyContent = document.createElement('div');
        storyContent.className = 'story-content';
        storyContent.id = `${story.id}-story`;
        
        // Podziel treść na akapity i dodaj do kontenera
        // Obsługujemy zarówno \n\n jak i pojedyncze \n (różne formaty z API)
        let paragraphs = [];
        if (story.content.includes('\n\n')) {
            paragraphs = story.content.split('\n\n');
        } else {
            paragraphs = story.content.split('\n').filter(p => p.trim() !== '');
        }
        
        paragraphs.forEach(paragraph => {
            const p = document.createElement('p');
            p.textContent = paragraph.trim();
            storyContent.appendChild(p);
        });
        
        // Dodaj nagłówek i treść do głównego kontenera
        storyAccordion.appendChild(storyHeader);
        storyAccordion.appendChild(storyContent);
        
        // Dodaj funkcjonalność akordeonu
        storyHeader.addEventListener('click', function() {
            // Przełącz widoczność treści
            storyContent.classList.toggle('visible');
            
            // Przełącz stan aktywny nagłówka
            this.classList.toggle('active');
            
            // Zamknij inne otwarte bajki
            const allHeaders = document.querySelectorAll('.story-header');
            allHeaders.forEach(header => {
                if (header !== this && header.classList.contains('active')) {
                    header.classList.remove('active');
                    const otherId = header.dataset.story;
                    document.getElementById(`${otherId}-story`).classList.remove('visible');
                }
            });
        });
        
        return storyAccordion;
    },
    
    // Dodaje wszystkie zapisane bajki do interfejsu
    renderSavedStories: function() {
        const stories = this.getSavedStories();
        const storiesContainer = document.querySelector('.bedtime-stories');
        
        if (!storiesContainer) {
            console.error('Nie znaleziono kontenera na bajki (.bedtime-stories)');
            return;
        }
        
        // Dodaj tylko nowe bajki (te, których jeszcze nie ma w interfejsie)
        stories.forEach(story => {
            // Sprawdź czy bajka już istnieje w interfejsie
            if (!document.querySelector(`.story-header[data-story="${story.id}"]`)) {
                const storyElement = this.createStoryElement(story);
                storiesContainer.appendChild(storyElement);
            }
        });
    },
    
    // Generuje i dodaje nową bajkę jeśli spełnione są warunki
    checkAndGenerateNewStory: async function() {
        if (this.shouldGenerateNewStory()) {
            try {
                // Próbuj wygenerować bajkę z API jeśli jest włączone
                let newStory = null;
                if (STORY_API_CONFIG.settings.useExternalApi && STORY_API_CONFIG.openrouter.enabled) {
                    console.log('Próba generowania bajki przez API OpenRouter...');
                    newStory = await this.generateStoryWithAPI();
                }
                
                // Jeśli nie udało się wygenerować bajki z API, użyj lokalnego generatora
                if (!newStory) {
                    console.log('Używanie lokalnego generatora bajek...');
                    newStory = this.generateNewStory();
                }
                
                // Zapisz bajkę i aktualizuj interfejs
                this.saveStory(newStory);
                this.limitStoredStories();
                
                // Dodaj bajkę do interfejsu
                const storyElement = this.createStoryElement(newStory);
                const storiesContainer = document.querySelector('.bedtime-stories');
                
                // Dodaj nową bajkę na początek listy
                if (storiesContainer.firstChild) {
                    storiesContainer.insertBefore(storyElement, storiesContainer.firstChild);
                } else {
                    storiesContainer.appendChild(storyElement);
                }
                
                // Pokaż powiadomienie
                const toastEl = document.getElementById('app-toast');
                if (toastEl) {
                    document.getElementById('toast-title').textContent = 'Nowa bajka!';
                    document.getElementById('toast-message').textContent = `Dodano nową bajkę: "${newStory.title}"`;
                    const toast = new bootstrap.Toast(toastEl);
                    toast.show();
                }
                
                return true;
            } catch (error) {
                console.error('Błąd podczas generowania bajki:', error);
                return false;
            }
        }
        
        return false;
    },
    
    // Generuje bajkę przy użyciu zewnętrznego API
    generateStoryWithAPI: async function() {
    try {
        const apiConfig = STORY_API_CONFIG.openrouter;
        
        // Sprawdź, czy API jest włączone i czy klucz API jest dostępny
        if (!STORY_API_CONFIG.settings.useExternalApi || !apiConfig.enabled) {
            console.log('API zewnętrzne wyłączone. Używanie generatora lokalnego.');
            return null;
        }
        
        // Dokładniejsza walidacja klucza API
        const apiKey = apiConfig.apiKey;
        if (!apiKey || apiKey.trim() === '') {
            console.log('Brak klucza API. Używanie generatora lokalnego.');
            
            // Pokaż powiadomienie o braku klucza API
            const toastEl = document.getElementById('app-toast');
            if (toastEl) {
                document.getElementById('toast-title').textContent = 'Brak klucza API';
                document.getElementById('toast-message').textContent = 'Wprowadź klucz API OpenRouter, aby generować bajki z AI.';
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
            
            return null;
        }
        
        // Pobierz prompt bezpośrednio z funkcji
        const promptText = getStoryPrompt();
        
        // SYSTEM PONOWNYCH PRÓB
        let retries = 0;
        const maxRetries = 3;
        let lastError = null;
        
        while (retries <= maxRetries) {
            try {
                // Dodaj timeout do zapytania
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 sekund timeout (skrócony)
                
                console.log(`Próba ${retries + 1} z ${maxRetries + 1} łączenia z API...`);
                
                // ZMODYFIKOWANE ZAPYTANIE API - BEZ ZBĘDNYCH NAGŁÓWKÓW
                const response = await fetch(apiConfig.endpoint, {
                    method: 'POST',
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: apiConfig.model,
                        messages: [
                            { role: "system", content: "Jesteś pomocnym asystentem specjalizującym się w tworzeniu bajek na dobranoc dla kobiet w języku polskim." },
                            { role: "user", content: promptText }
                        ],
                        max_tokens: 600, // ZMNIEJSZONO dla szybszej odpowiedzi
                        temperature: apiConfig.temperature
                    })
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Nie można odczytać treści błędu');
                    throw new Error(`Błąd API: ${response.status} ${response.statusText} - ${errorText}`);
                }
                
                const data = await response.json();
                const content = data.choices && data.choices[0] && data.choices[0].message ? data.choices[0].message.content : null;
                
                if (!content) {
                    throw new Error("Otrzymano pustą odpowiedź z API");
                }
                
                // Przetwarzanie odpowiedzi JSON...
                // Usunięcie znaczników formatowania Markdown
                let cleanedContent = content;
                cleanedContent = cleanedContent.replace(/^\s*```(?:json)?\s*/i, '');
                cleanedContent = cleanedContent.replace(/\s*```\s*$/i, '');
                
                console.log("Oryginalna treść z API:", content);
                console.log("Oczyszczona treść przed parsowaniem:", cleanedContent);
                
                // Znajdź JSON w oczyszczonej odpowiedzi
                const jsonMatch = cleanedContent.match(/\{[\s\S]*\}/);
                let storyData;
                
                if (jsonMatch) {
                    // Spróbuj sparsować JSON
                    try {
                        storyData = JSON.parse(jsonMatch[0]);
                    } catch (jsonSyntaxError) {
                        console.error("Błąd składni JSON:", jsonSyntaxError, "w treści:", jsonMatch[0]);
                        
                        // Jeśli nie udało się sparsować JSON, spróbuj naprawić typowe problemy
                        let fixedJson = jsonMatch[0]
                            .replace(/,\s*}/g, '}') // usuń końcowe przecinki
                            .replace(/,\s*,/g, ',') // usuń podwójne przecinki
                            .replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2":'); // popraw klucze bez cudzysłowów
                            
                        try {
                            storyData = JSON.parse(fixedJson);
                            console.log("Naprawiono JSON:", fixedJson);
                        } catch (e) {
                            // Jeśli nadal nie działa, wykorzystaj alternatywne podejście
                            throw jsonSyntaxError;
                        }
                    }
                } else {
                    // Jeśli nie znaleziono poprawnego JSON, spróbuj przetworzyć odpowiedź w inny sposób
                    const lines = cleanedContent.split('\n').filter(line => line.trim() !== '');
                    const title = lines[0].replace(/^#+ /, '').trim(); // Usuń znaczniki Markdown nagłówka
                    const storyContent = lines.slice(1).join('\n\n');
                    
                    storyData = {
                        title: title || "Bajka o Renatce i Dziubasku",
                        icon: "star", // Domyślna ikona
                        content: storyContent || cleanedContent
                    };
                }
                
                // Utwórz obiekt bajki
                const newStory = {
                    id: 'story-api-' + Date.now(),
                    title: storyData.title || `Bajka o Renatce i Dziubasku`,
                    icon: storyData.icon || "star",
                    content: storyData.content || content,
                    dateGenerated: new Date().toISOString(),
                    source: 'api'
                };
                
                console.log("Pomyślnie wygenerowano bajkę z API:", newStory.title);
                return newStory;
                
            } catch (fetchError) {
                lastError = fetchError;
                retries++;
                console.error(`Próba ${retries} zakończyła się błędem:`, fetchError);
                
                if (retries <= maxRetries) {
                    // Opóźnienie przed kolejną próbą
                    console.log(`Oczekiwanie ${retries * 2} sekund przed ponowną próbą...`);
                    await new Promise(resolve => setTimeout(resolve, retries * 2000));
                }
            }
        }
        
        // Wszystkie próby nieudane
        throw lastError || new Error("Nie udało się połączyć z API po wyczerpaniu prób");
        
    } catch (error) {
        console.error('Ostateczny błąd podczas generowania bajki przez API:', error);
        
        // Pokaż powiadomienie o problemie
        const toastEl = document.getElementById('app-toast');
        if (toastEl) {
            document.getElementById('toast-title').textContent = 'Problem z generacją bajki';
            document.getElementById('toast-message').textContent = 'Wystąpił problem z połączeniem do API. Używam lokalnego generatora bajek.';
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
        
        // Jeśli włączony jest tryb awaryjny, zwróć null aby uruchomić lokalny generator
        if (STORY_API_CONFIG.settings.fallbackToLocal) {
            console.log('Przełączanie na lokalny generator bajek...');
            return null;
        }
        
        throw error;
    }
},
    
    // Ogranicza liczbę przechowywanych bajek do maksymalnej wartości
    limitStoredStories: function() {
        const maxStories = STORY_API_CONFIG.settings.maxStoriesToKeep;
        let stories = this.getSavedStories();
        
        if (stories.length > maxStories) {
            // Sortuj według daty generowania (najnowsze pierwsze)
            stories.sort((a, b) => new Date(b.dateGenerated) - new Date(a.dateGenerated));
            
            // Zachowaj tylko określoną liczbę bajek
            stories = stories.slice(0, maxStories);
            
            // Zapisz z powrotem do localStorage
            localStorage.setItem('generatedStories', JSON.stringify(stories));
            
            console.log(`Ograniczono liczbę przechowywanych bajek do ${maxStories}`);
        }
    },
    
    // Inicjalizuje generator bajek
    init: function() {
        console.log('Inicjalizacja generatora bajek...');
        
        // Renderuj zapisane bajki
        this.renderSavedStories();
        
        // Ogranicz liczbę przechowywanych bajek
        this.limitStoredStories();
        
        // Sprawdź czy należy wygenerować nową bajkę
        if (STORY_API_CONFIG.settings.checkNewStoryOnLoad) {
            this.checkAndGenerateNewStory();
        }
        
        // Dodaj przycisk do ręcznego generowania bajek
        const storiesContent = document.getElementById('stories-content');
        if (storiesContent) {
            // Sprawdź czy przycisk już istnieje
            if (!document.getElementById('generate-story-btn')) {
                const generateButton = document.createElement('button');
                generateButton.id = 'generate-story-btn';
                generateButton.className = 'sound-btn mt-3 mb-3';
                generateButton.innerHTML = '<i class="fas fa-magic"></i> Wygeneruj nową bajkę';
                
                // Obsługa kliknięcia przycisku - generowanie nowej bajki
                // Obsługa kliknięcia przycisku - generowanie nowej bajki
generateButton.addEventListener('click', async () => {
    // Zmień etykietę przycisku podczas generowania
    generateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generowanie...';
    generateButton.disabled = true;
    
    // Dodaj timer zabezpieczający przed zawieszeniem
    const safetyTimeout = setTimeout(() => {
        // Jeśli generowanie trwa zbyt długo, przerwij je
        if (generateButton.disabled) {
            console.log('Przekroczono maksymalny czas generowania bajki (45s)');
            generateButton.innerHTML = '<i class="fas fa-magic"></i> Wygeneruj nową bajkę';
            generateButton.disabled = false;
            
            // Pokaż komunikat
            const toastEl = document.getElementById('app-toast');
            if (toastEl) {
                document.getElementById('toast-title').textContent = 'Przerwano generowanie';
                document.getElementById('toast-message').textContent = 'Generowanie bajki trwało zbyt długo i zostało przerwane. Użyto lokalnego generatora.';
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
            
            // Wygeneruj bajkę lokalnie
            try {
                const localStory = this.generateNewStory();
                this.saveStory(localStory);
                
                // Dodaj bajkę do interfejsu
                const storyElement = this.createStoryElement(localStory);
                const storiesContainer = document.querySelector('.bedtime-stories');
                if (storiesContainer.firstChild) {
                    storiesContainer.insertBefore(storyElement, storiesContainer.firstChild);
                } else {
                    storiesContainer.appendChild(storyElement);
                }
                
                // Zapisz datę wygenerowania bajki
                localStorage.setItem('lastStoryGenerationDate', new Date().toISOString());
            } catch (e) {
                console.error('Błąd podczas generowania lokalnej bajki:', e);
            }
        }
    }, 55000); // 45 sekund
    
    try {
        // Próbuj wygenerować bajkę z API jeśli jest włączone
        let newStory = null;
        if (STORY_API_CONFIG.settings.useExternalApi && STORY_API_CONFIG.openrouter.enabled) {
            newStory = await this.generateStoryWithAPI();
        }
        
        // Jeśli nie udało się wygenerować bajki z API, użyj lokalnego generatora
        if (!newStory) {
            newStory = this.generateNewStory();
        }
        
        // Anuluj timer bezpieczeństwa bo generowanie się udało
        clearTimeout(safetyTimeout);
        
        // Zapisz bajkę
        this.saveStory(newStory);
        
        // Limituj liczbę przechowywanych bajek
        this.limitStoredStories();
        
        // Dodaj bajkę do interfejsu
        const storyElement = this.createStoryElement(newStory);
        const storiesContainer = document.querySelector('.bedtime-stories');
        
        // Dodaj nową bajkę na początek listy
        if (storiesContainer.firstChild) {
            storiesContainer.insertBefore(storyElement, storiesContainer.firstChild);
        } else {
            storiesContainer.appendChild(storyElement);
        }
        
        // Pokaż powiadomienie
        const toastEl = document.getElementById('app-toast');
        if (toastEl) {
            document.getElementById('toast-title').textContent = 'Nowa bajka!';
            document.getElementById('toast-message').textContent = `Dodano nową bajkę: "${newStory.title}"`;
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
        
        // Zapisz datę wygenerowania bajki
        localStorage.setItem('lastStoryGenerationDate', new Date().toISOString());
        
    } catch (error) {
        // Anuluj timer bezpieczeństwa bo generowanie już się zakończyło (z błędem)
        clearTimeout(safetyTimeout);
        
        console.error('Błąd podczas generowania bajki:', error);
        
        // Wygeneruj bajkę lokalnie w przypadku błędu
        if (STORY_API_CONFIG.settings.fallbackToLocal) {
            try {
                const localStory = this.generateNewStory();
                this.saveStory(localStory);
                
                // Dodaj bajkę do interfejsu
                const storyElement = this.createStoryElement(localStory);
                const storiesContainer = document.querySelector('.bedtime-stories');
                if (storiesContainer.firstChild) {
                    storiesContainer.insertBefore(storyElement, storiesContainer.firstChild);
                } else {
                    storiesContainer.appendChild(storyElement);
                }
                
                // Pokaż powiadomienie o użyciu lokalnego generatora
                const toastEl = document.getElementById('app-toast');
                if (toastEl) {
                    document.getElementById('toast-title').textContent = 'Nowa bajka';
                    document.getElementById('toast-message').textContent = `Dodano nową bajkę: "${localStory.title}"`;
                    const toast = new bootstrap.Toast(toastEl);
                    toast.show();
                }
                
                // Zapisz datę wygenerowania bajki
                localStorage.setItem('lastStoryGenerationDate', new Date().toISOString());
            } catch (localError) {
                console.error('Błąd podczas generowania lokalnej bajki:', localError);
            }
        }
    } finally {
        // Przywróć etykietę przycisku
        generateButton.innerHTML = '<i class="fas fa-magic"></i> Wygeneruj nową bajkę';
        generateButton.disabled = false;
    }
});
                
                // Wstaw przycisk przed kontenerem bajek
                const bedtimeStories = storiesContent.querySelector('.bedtime-stories');
                if (bedtimeStories) {
                    storiesContent.insertBefore(generateButton, bedtimeStories);
                } else {
                    storiesContent.appendChild(generateButton);
                }
            }
        }
    }
};

// Dodaj inicjalizację UI w funkcji init() generatora bajek
const originalInit = bajkiGenerator.init;
bajkiGenerator.init = function() {
    // Wywołaj oryginalną funkcję init
    originalInit.call(this);
    
    // Dodaj UI do zarządzania kluczem API
    ApiKeyManager.addApiKeyUI();
};

// Inicjalizacja generatora bajek po załadowaniu strony
document.addEventListener('DOMContentLoaded', function() {
    // Dodaj inicjalizację generatora bajek do istniejących inicjalizacji
    setTimeout(() => {
        bajkiGenerator.init();
    }, 1500); // Małe opóźnienie, aby upewnić się, że strona jest w pełni załadowana
});

// Zaktualizuj funkcję generowania bajek z API
const originalGenerateStoryWithAPI = bajkiGenerator.generateStoryWithAPI;
bajkiGenerator.generateStoryWithAPI = async function() {
    // Sprawdź, czy mamy klucz API
    if (!ApiKeyManager.hasApiKey()) {
        console.log('Brak klucza API OpenRouter. Używanie lokalnego generatora bajek.');
        // Pokaż powiadomienie
        const toastEl = document.getElementById('app-toast');
        if (toastEl) {
            document.getElementById('toast-title').textContent = 'Brak klucza API';
            document.getElementById('toast-message').textContent = 'Wprowadź klucz API OpenRouter, aby generować bajki z AI.';
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
        return null;
    }
    
    // Aktualizuj klucz API w konfiguracji
    STORY_API_CONFIG.openrouter.apiKey = ApiKeyManager.getApiKey();
    
    // Użyj oryginalnej funkcji
    return await originalGenerateStoryWithAPI.call(this);
};
        // Syntezator mowy do bajek na dobranoc
const StoryVoiceSynthesizer = {
    // Przechowuje instancję syntezatora
    synth: window.speechSynthesis,
    
    // Bieżące wypowiadanie
    currentUtterance: null,
    
    // Czy syntezator jest dostępny
    isSupported: function() {
        return 'speechSynthesis' in window;
    },
    
    // Parametry głosu
    voiceParams: {
        rate: 0.9,      // Nieco wolniejsze tempo (0.1 to 10)
        pitch: 0.9,     // Nieco niższy ton (0 to 2)
        volume: 1.0     // Pełna głośność (0 to 1)
    },
    
    // Inicjalizacja syntezatora
    init: function() {
        // Sprawdź wsparcie przeglądarki
        if (!this.isSupported()) {
            console.warn('Synteza mowy nie jest wspierana przez tę przeglądarkę.');
            return false;
        }
        
        // Ładowanie głosów 
        this.loadVoices();
        
        // Nasłuchuj na zmiany głosów (ważne w Chrome)
        if (this.synth.onvoiceschanged !== undefined) {
            this.synth.onvoiceschanged = this.loadVoices.bind(this);
        }
        
        // Inicjalizacja powiodła się
        return true;
    },
    
    // Ładowanie dostępnych głosów
    loadVoices: function() {
        this.voices = this.synth.getVoices();
        
        // Próba znalezienia głosu męskiego po języku polskim
        this.selectedVoice = this.findBestMaleVoice();
        
        console.log('Dostępne głosy:', this.voices);
        console.log('Wybrany głos:', this.selectedVoice);
    },
    
    // Znajdowanie najlepszego męskiego głosu
    findBestMaleVoice: function() {
        // Priorytety dla wyszukiwania głosu:
        // 1. Polski męski głos
        // 2. Dowolny polski głos
        // 3. Angielski męski głos
        // 4. Dowolny męski głos
        // 5. Pierwszy dostępny głos
        
        const voices = this.voices || [];
        
        // Szukamy polskiego męskiego głosu
        let polishMaleVoice = voices.find(voice => 
            voice.lang.startsWith('pl') && 
            voice.name.toLowerCase().includes('male') ||
            voice.name.toLowerCase().includes('męski') ||
            voice.name.toLowerCase().includes('adam') ||
            voice.name.toLowerCase().includes('jacek')
        );
        
        if (polishMaleVoice) return polishMaleVoice;
        
        // Dowolny polski głos
        let polishVoice = voices.find(voice => voice.lang.startsWith('pl'));
        if (polishVoice) return polishVoice;
        
        // Angielski męski głos
        let englishMaleVoice = voices.find(voice => 
            voice.lang.startsWith('en') && 
            (voice.name.toLowerCase().includes('male') ||
             voice.name.toLowerCase().includes('david') ||
             voice.name.toLowerCase().includes('mark') ||
             voice.name.toLowerCase().includes('james'))
        );
        
        if (englishMaleVoice) return englishMaleVoice;
        
        // Dowolny męski głos
        let maleVoice = voices.find(voice => 
            voice.name.toLowerCase().includes('male') ||
            !voice.name.toLowerCase().includes('female')
        );
        
        if (maleVoice) return maleVoice;
        
        // Fallback: pierwszy dostępny głos
        return voices[0];
    },
    
    // Funkcja czytająca tekst
    speak: function(text) {
        if (!this.isSupported() || !text) return;
        
        // Zatrzymaj aktualnie czytany tekst
        this.stop();
        
        // Utwórz nową wypowiedź
        this.currentUtterance = new SpeechSynthesisUtterance(text);
        
        // Ustaw parametry
        this.currentUtterance.voice = this.selectedVoice;
        this.currentUtterance.rate = this.voiceParams.rate;
        this.currentUtterance.pitch = this.voiceParams.pitch;
        this.currentUtterance.volume = this.voiceParams.volume;
        
        // Zdarzenia do zarządzania stanem odtwarzania
        this.currentUtterance.onstart = () => {
            this.isSpeaking = true;
            this.updateButtonState();
        };
        
        this.currentUtterance.onend = () => {
            this.isSpeaking = false;
            this.updateButtonState();
        };
        
        this.currentUtterance.onerror = (event) => {
            console.error('Błąd syntezy mowy:', event);
            this.isSpeaking = false;
            this.updateButtonState();
        };
        
        // Rozpocznij czytanie
        this.synth.speak(this.currentUtterance);
        this.isSpeaking = true;
        
        // Aktualizuj stan przycisków
        this.updateButtonState();
    },
    
    // Wstrzymanie odtwarzania
    pause: function() {
        if (this.isSpeaking && this.synth) {
            this.synth.pause();
            this.isSpeaking = false;
            this.isPaused = true;
            this.updateButtonState();
        }
    },
    
    // Wznowienie odtwarzania
    resume: function() {
        if (this.isPaused && this.synth) {
            this.synth.resume();
            this.isSpeaking = true;
            this.isPaused = false;
            this.updateButtonState();
        }
    },
    
    // Zatrzymanie odtwarzania
    stop: function() {
        if (this.synth) {
            this.synth.cancel();
            this.isSpeaking = false;
            this.isPaused = false;
            this.updateButtonState();
        }
    },
    
    // Aktualizacja stanu przycisków
    updateButtonState: function() {
        const playButtons = document.querySelectorAll('.story-play-btn');
        const pauseButtons = document.querySelectorAll('.story-pause-btn');
        const stopButtons = document.querySelectorAll('.story-stop-btn');
        
        playButtons.forEach(btn => {
            btn.style.display = (this.isSpeaking || this.isPaused) ? 'none' : 'inline-block';
        });
        
        pauseButtons.forEach(btn => {
            btn.style.display = this.isSpeaking ? 'inline-block' : 'none';
        });
        
        stopButtons.forEach(btn => {
            btn.style.display = (this.isSpeaking || this.isPaused) ? 'inline-block' : 'none';
        });
    },
    
    // Pobieranie tekstu bajki z elementu DOM
    getStoryText: function(storyContentElement) {
        if (!storyContentElement) return '';
        
        // Zbierz tekst ze wszystkich paragrafów
        const paragraphs = Array.from(storyContentElement.querySelectorAll('p'));
        return paragraphs.map(p => p.textContent).join(' ');
    },
    
    // Dodanie przycisków do wszystkich bajek
    addSpeechButtonsToStories: function() {
        if (!this.isSupported()) return;
        
        // Dodaj przycisk do każdego nagłówka bajki
        const storyHeaders = document.querySelectorAll('.story-header');
        
        storyHeaders.forEach(header => {
            // Sprawdź czy przyciski już istnieją
            if (header.querySelector('.story-speech-controls')) return;
            
            // Pobierz ID bajki
            const storyId = header.dataset.story;
            if (!storyId) return;
            
            // Znajdź treść bajki
            const storyContent = document.getElementById(`${storyId}-story`);
            if (!storyContent) return;
            
            // Utwórz kontener na przyciski
            const speechControls = document.createElement('div');
            speechControls.className = 'story-speech-controls';
            speechControls.style.display = 'flex';
            speechControls.style.alignItems = 'center';
            speechControls.style.gap = '8px';
            
            // Przycisk odtwarzania
            const playButton = document.createElement('button');
            playButton.className = 'story-play-btn';
            playButton.innerHTML = '<i class="fas fa-play"></i>';
            playButton.title = 'Odtwórz bajkę głosem';
            playButton.style.display = 'inline-block';
            playButton.style.background = 'var(--accent)';
            playButton.style.color = 'var(--primary-dark)';
            playButton.style.border = 'none';
            playButton.style.borderRadius = '50%';
            playButton.style.width = '30px';
            playButton.style.height = '30px';
            playButton.style.cursor = 'pointer';
            
            // Przycisk pauzy
            const pauseButton = document.createElement('button');
            pauseButton.className = 'story-pause-btn';
            pauseButton.innerHTML = '<i class="fas fa-pause"></i>';
            pauseButton.title = 'Wstrzymaj odtwarzanie';
            pauseButton.style.display = 'none';
            pauseButton.style.background = 'var(--accent)';
            pauseButton.style.color = 'var(--primary-dark)';
            pauseButton.style.border = 'none';
            pauseButton.style.borderRadius = '50%';
            pauseButton.style.width = '30px';
            pauseButton.style.height = '30px';
            pauseButton.style.cursor = 'pointer';
            
            // Przycisk stop
            const stopButton = document.createElement('button');
            stopButton.className = 'story-stop-btn';
            stopButton.innerHTML = '<i class="fas fa-stop"></i>';
            stopButton.title = 'Zatrzymaj odtwarzanie';
            stopButton.style.display = 'none';
            stopButton.style.background = 'var(--accent)';
            stopButton.style.color = 'var(--primary-dark)';
            stopButton.style.border = 'none';
            stopButton.style.borderRadius = '50%';
            stopButton.style.width = '30px';
            stopButton.style.height = '30px';
            stopButton.style.cursor = 'pointer';
            
            // Dodaj obsługę zdarzeń
            playButton.addEventListener('click', (e) => {
                e.stopPropagation(); // Zapobiega zamknięciu/otwarciu bajki
                
                // Jeśli bajka nie jest otwarta, otwórz ją
                if (!storyContent.classList.contains('visible')) {
                    header.click();
                }
                
                // Pobierz tekst bajki
                const storyText = this.getStoryText(storyContent);
                
                // Rozpocznij czytanie
                this.speak(storyText);
            });
            
            pauseButton.addEventListener('click', (e) => {
                e.stopPropagation();
                if (this.isSpeaking) {
                    this.pause();
                } else if (this.isPaused) {
                    this.resume();
                }
            });
            
            stopButton.addEventListener('click', (e) => {
                e.stopPropagation();
                this.stop();
            });
            
            // Dodaj przyciski do kontenera
            speechControls.appendChild(playButton);
            speechControls.appendChild(pauseButton);
            speechControls.appendChild(stopButton);
            
            // Znajdź pierwszy nagłówek h4 w nagłówku bajki
            const h4 = header.querySelector('h4');
            
            if (h4) {
                // Utwórz wrapper, aby zachować układ
                const wrapper = document.createElement('div');
                wrapper.style.display = 'flex';
                wrapper.style.justifyContent = 'space-between';
                wrapper.style.alignItems = 'center';
                wrapper.style.width = '100%';
                
                // Dodaj nagłówek do wrappera
                h4.parentNode.insertBefore(wrapper, h4);
                wrapper.appendChild(h4);
                
                // Dodaj przyciski do wrappera
                wrapper.appendChild(speechControls);
            } else {
                // Jeśli nie ma nagłówka h4, dodaj przyciski bezpośrednio do nagłówka
                header.appendChild(speechControls);
            }
        });
    },
    
    // Obserwator mutacji DOM, aby dodawać przyciski do nowo dodanych bajek
    observeStoryAdditions: function() {
        // Obserwator mutacji DOM
        const observer = new MutationObserver((mutations) => {
            let needsUpdate = false;
            
            mutations.forEach(mutation => {
                // Sprawdź, czy dodano nowe elementy
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    // Sprawdź, czy któryś z dodanych elementów jest bajką
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === 1) { // Typ Node.ELEMENT_NODE
                            if (node.classList && (
                                node.classList.contains('story-accordion') || 
                                node.querySelector('.story-accordion')
                            )) {
                                needsUpdate = true;
                            }
                        }
                    });
                }
            });
            
            // Jeśli dodano nowe bajki, dodaj do nich przyciski
            if (needsUpdate) {
                this.addSpeechButtonsToStories();
            }
        });
        
        // Rozpocznij obserwację sekcji bajek
        const storiesContainer = document.querySelector('.bedtime-stories');
        if (storiesContainer) {
            observer.observe(storiesContainer, { 
                childList: true, 
                subtree: true 
            });
        }
    }
};

// Inicjalizacja syntezatora mowy po załadowaniu strony
document.addEventListener('DOMContentLoaded', function() {
    // Opóźnij inicjalizację syntezatora o 2 sekundy, aby dać przeglądarce czas na załadowanie głosów
    setTimeout(() => {
        // Inicjalizacja syntezatora
        if (StoryVoiceSynthesizer.init()) {
            // Dodaj przyciski do wszystkich bajek
            StoryVoiceSynthesizer.addSpeechButtonsToStories();
            // Obserwuj dodawanie nowych bajek
            StoryVoiceSynthesizer.observeStoryAdditions();
            
            // Dodaj nasłuchiwacz do dodawania przycisków po kliknięciu na zakładkę bajek
            const storiesTab = document.querySelector('.exercise-tab[data-tab="stories"]');
            if (storiesTab) {
                storiesTab.addEventListener('click', () => {
                    setTimeout(() => StoryVoiceSynthesizer.addSpeechButtonsToStories(), 300);
                });
            }
            
            console.log('Syntezator mowy zainicjalizowany pomyślnie.');
        } else {
            console.warn('Nie udało się zainicjalizować syntezatora mowy.');
        }
    }, 2000);
});
        // Dodaj obsługę zdarzenia beforeunload, aby zapobiec utracie połączenia podczas generowania bajki
window.addEventListener('beforeunload', function(e) {
    // Sprawdź, czy trwa generowanie bajki
    const generateButton = document.getElementById('generate-story-btn');
    if (generateButton && generateButton.disabled && generateButton.innerHTML.includes('Generowanie')) {
        // Pokaż powiadomienie o trwającej operacji
        const message = 'Trwa generowanie bajki. Czy na pewno chcesz opuścić stronę?';
        e.returnValue = message;
        return message;
    }
});
    </script>
